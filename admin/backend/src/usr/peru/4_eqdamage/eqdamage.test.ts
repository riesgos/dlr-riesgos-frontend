import express from 'express';
import axios from 'axios';
import { Server } from 'http';
import { addScenarioApi } from '../../../scenarios/scenario.interface';
import { peruFactory } from '../peru';
import { DatumReference, ScenarioState } from '../../../scenarios/scenarios';
import { sleep } from '../../../utils/async';
import { createDirIfNotExists, deleteFile } from '../../../utils/files';


const port = 1416;
const logDir = `./test-data/peru-eqdmg/logs/`; // server-logs
const storeDir = `./test-data/peru-eqdmg/store/`;  

let server: Server;
beforeAll(async () => {
    await deleteFile(logDir);
    await deleteFile(storeDir);
    await createDirIfNotExists(logDir);
    await createDirIfNotExists(storeDir);

    const app = express();
    app.use(express.json());
    const scenarioFactories = [peruFactory];

    addScenarioApi(app, scenarioFactories, storeDir, logDir);
    server = app.listen(port, () => console.log(`app listening on port ${port}`));
})

afterAll(async () => {
    server.close();
});


test('Testing eq-damage', async () => {
    const stepId = 'EqDamage';

    const state: ScenarioState = {
        data: [{
            id: 'selectedEq',
            value: {
                "type": "Feature",
                "geometry": {
                    "type": "Point",
                    "coordinates": [
                        -77.9318,
                        -12.1908
                    ]
                },
                "properties": {
                    "publicID": "quakeml:quakeledger/peru_70000011",
                    "preferredOriginID": "quakeml:quakeledger/peru_70000011",
                    "preferredMagnitudeID": "quakeml:quakeledger/peru_70000011",
                    "type": "earthquake",
                    "description.text": "observed",
                    "origin.publicID": "quakeml:quakeledger/peru_70000011",
                    "origin.time.value": "1746-10-28T00:00:00.000000Z",
                    "origin.depth.value": "8.0",
                    "origin.creationInfo.value": "GFZ",
                    "magnitude.publicID": "quakeml:quakeledger/peru_70000011",
                    "magnitude.mag.value": "9.0",
                    "magnitude.type": "MW",
                    "magnitude.creationInfo.value": "GFZ",
                    "focalMechanism.publicID": "quakeml:quakeledger/peru_70000011",
                    "focalMechanism.nodalPlanes.nodalPlane1.strike.value": "329.0",
                    "focalMechanism.nodalPlanes.nodalPlane1.dip.value": "20.0",
                    "focalMechanism.nodalPlanes.nodalPlane1.rake.value": "90.0",
                    "focalMechanism.nodalPlanes.preferredPlane": "nodalPlane1"
                },
                "id": "quakeml:quakeledger/peru_70000011"
            }
        }, {
            id: 'gmpe',
            value: 'MontalvaEtAl2016SInter'
        }, {
            id: 'vsgrid',
            value: 'USGSSlopeBasedTopographyProxy'
        }, {
            id: 'eqSim',
            value: {
                "type": "FeatureCollection",
                "features": [
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "LineString",
                            "coordinates": [
                                [
                                    -81.0517,
                                    -6.1067
                                ],
                                [
                                    -81.05,
                                    -6.105
                                ],
                                [
                                    -81.0474,
                                    -6.1058
                                ],
                                [
                                    -81.0432,
                                    -6.1068
                                ],
                                [
                                    -81.0417,
                                    -6.1072
                                ],
                                [
                                    -81.0407,
                                    -6.1074
                                ],
                                [
                                    -81.0372,
                                    -6.1083
                                ],
                                [
                                    -81.0405,
                                    -6.1095
                                ],
                                [
                                    -81.0417,
                                    -6.1089
                                ],
                                [
                                    -81.0423,
                                    -6.109
                                ],
                                [
                                    -81.0486,
                                    -6.1097
                                ],
                                [
                                    -81.05,
                                    -6.1098
                                ],
                                [
                                    -81.0509,
                                    -6.1093
                                ],
                                [
                                    -81.0514,
                                    -6.1083
                                ],
                                [
                                    -81.0517,
                                    -6.1067
                                ]
                            ]
                        },
                        "properties": {
                            "value": 0.05
                        },
                        "id": "0"
                    },
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "LineString",
                            "coordinates": [
                                [
                                    -81.0441,
                                    -5.975
                                ],
                                [
                                    -81.0427,
                                    -5.9739
                                ],
                                [
                                    -81.0417,
                                    -5.9736
                                ],
                                [
                                    -81.0402,
                                    -5.9735
                                ],
                                [
                                    -81.0399,
                                    -5.975
                                ],
                                [
                                    -81.0404,
                                    -5.9762
                                ],
                                [
                                    -81.0417,
                                    -5.9774
                                ],
                                [
                                    -81.0432,
                                    -5.9766
                                ],
                                [
                                    -81.0441,
                                    -5.975
                                ]
                            ]
                        },
                        "properties": {
                            "value": 0.05
                        },
                        "id": "1"
                    },
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "LineString",
                            "coordinates": [
                                [
                                    -81.0351,
                                    -6.0083
                                ],
                                [
                                    -81.0347,
                                    -6.0069
                                ],
                                [
                                    -81.0333,
                                    -6.0066
                                ],
                                [
                                    -81.0323,
                                    -6.0073
                                ],
                                [
                                    -81.0319,
                                    -6.0083
                                ],
                                [
                                    -81.0321,
                                    -6.0096
                                ],
                                [
                                    -81.0333,
                                    -6.0108
                                ],
                                [
                                    -81.0346,
                                    -6.0096
                                ],
                                [
                                    -81.0351,
                                    -6.0083
                                ]
                            ]
                        },
                        "properties": {
                            "value": 0.05
                        },
                        "id": "2"
                    },
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "LineString",
                            "coordinates": [
                                [
                                    -81.0339,
                                    -5.9672
                                ],
                                [
                                    -81.0338,
                                    -5.9667
                                ],
                                [
                                    -81.0336,
                                    -5.9664
                                ],
                                [
                                    -81.0333,
                                    -5.9661
                                ],
                                [
                                    -81.0329,
                                    -5.9662
                                ],
                                [
                                    -81.0326,
                                    -5.9667
                                ],
                                [
                                    -81.0329,
                                    -5.9671
                                ],
                                [
                                    -81.0333,
                                    -5.9672
                                ],
                                [
                                    -81.0339,
                                    -5.9672
                                ]
                            ]
                        },
                        "properties": {
                            "value": 0.05
                        },
                        "id": "3"
                    },
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "LineString",
                            "coordinates": [
                                [
                                    -80.9429,
                                    -5.8429
                                ],
                                [
                                    -80.9425,
                                    -5.8417
                                ],
                                [
                                    -80.9422,
                                    -5.8411
                                ],
                                [
                                    -80.9417,
                                    -5.8409
                                ],
                                [
                                    -80.9408,
                                    -5.8408
                                ],
                                [
                                    -80.9345,
                                    -5.8405
                                ],
                                [
                                    -80.9333,
                                    -5.8405
                                ],
                                [
                                    -80.9322,
                                    -5.8405
                                ],
                                [
                                    -80.926,
                                    -5.8407
                                ],
                                [
                                    -80.925,
                                    -5.8407
                                ],
                                [
                                    -80.9231,
                                    -5.8398
                                ],
                                [
                                    -80.9185,
                                    -5.8417
                                ],
                                [
                                    -80.9218,
                                    -5.8449
                                ],
                                [
                                    -80.925,
                                    -5.8468
                                ],
                                [
                                    -80.9277,
                                    -5.8473
                                ],
                                [
                                    -80.9312,
                                    -5.8479
                                ],
                                [
                                    -80.9333,
                                    -5.8482
                                ],
                                [
                                    -80.9355,
                                    -5.8478
                                ],
                                [
                                    -80.9391,
                                    -5.8474
                                ],
                                [
                                    -80.9417,
                                    -5.8469
                                ],
                                [
                                    -80.9429,
                                    -5.8429
                                ]
                            ]
                        },
                        "properties": {
                            "value": 0.05
                        },
                        "id": "4"
                    },
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "LineString",
                            "coordinates": [
                                [
                                    -80.9193,
                                    -5.836
                                ],
                                [
                                    -80.9185,
                                    -5.8333
                                ],
                                [
                                    -80.9179,
                                    -5.8321
                                ],
                                [
                                    -80.9167,
                                    -5.8315
                                ],
                                [
                                    -80.9134,
                                    -5.83
                                ],
                                [
                                    -80.9103,
                                    -5.8314
                                ],
                                [
                                    -80.9118,
                                    -5.8284
                                ],
                                [
                                    -80.9105,
                                    -5.825
                                ],
                                [
                                    -80.9098,
                                    -5.8235
                                ],
                                [
                                    -80.9083,
                                    -5.8228
                                ],
                                [
                                    -80.9051,
                                    -5.8218
                                ],
                                [
                                    -80.9017,
                                    -5.8233
                                ],
                                [
                                    -80.9024,
                                    -5.8191
                                ],
                                [
                                    -80.9011,
                                    -5.8167
                                ],
                                [
                                    -80.9007,
                                    -5.8159
                                ],
                                [
                                    -80.9,
                                    -5.8156
                                ],
                                [
                                    -80.8982,
                                    -5.8149
                                ],
                                [
                                    -80.8927,
                                    -5.8157
                                ],
                                [
                                    -80.8917,
                                    -5.8085
                                ],
                                [
                                    -80.8916,
                                    -5.8084
                                ],
                                [
                                    -80.8916,
                                    -5.8083
                                ],
                                [
                                    -80.8855,
                                    -5.8061
                                ],
                                [
                                    -80.8838,
                                    -5.8005
                                ],
                                [
                                    -80.8835,
                                    -5.8
                                ],
                                [
                                    -80.8835,
                                    -5.7998
                                ],
                                [
                                    -80.884,
                                    -5.7923
                                ],
                                [
                                    -80.884,
                                    -5.7917
                                ],
                                [
                                    -80.884,
                                    -5.791
                                ],
                                [
                                    -80.8849,
                                    -5.7849
                                ],
                                [
                                    -80.885,
                                    -5.7833
                                ],
                                [
                                    -80.8844,
                                    -5.7822
                                ],
                                [
                                    -80.8833,
                                    -5.7817
                                ],
                                [
                                    -80.8799,
                                    -5.7799
                                ],
                                [
                                    -80.8784,
                                    -5.78
                                ],
                                [
                                    -80.8786,
                                    -5.7786
                                ],
                                [
                                    -80.8771,
                                    -5.775
                                ],
                                [
                                    -80.8764,
                                    -5.7736
                                ],
                                [
                                    -80.875,
                                    -5.773
                                ],
                                [
                                    -80.8732,
                                    -5.7732
                                ],
                                [
                                    -80.8729,
                                    -5.775
                                ],
                                [
                                    -80.873,
                                    -5.777
                                ],
                                [
                                    -80.8734,
                                    -5.7817
                                ],
                                [
                                    -80.8735,
                                    -5.7833
                                ],
                                [
                                    -80.8735,
                                    -5.7848
                                ],
                                [
                                    -80.8742,
                                    -5.7908
                                ],
                                [
                                    -80.8742,
                                    -5.7917
                                ],
                                [
                                    -80.8742,
                                    -5.7925
                                ],
                                [
                                    -80.8744,
                                    -5.7994
                                ],
                                [
                                    -80.8744,
                                    -5.8
                                ],
                                [
                                    -80.8744,
                                    -5.8006
                                ],
                                [
                                    -80.875,
                                    -5.8083
                                ],
                                [
                                    -80.875,
                                    -5.8083
                                ],
                                [
                                    -80.8749,
                                    -5.8084
                                ],
                                [
                                    -80.875,
                                    -5.8092
                                ],
                                [
                                    -80.8766,
                                    -5.8151
                                ],
                                [
                                    -80.8774,
                                    -5.8167
                                ],
                                [
                                    -80.8803,
                                    -5.8197
                                ],
                                [
                                    -80.8833,
                                    -5.8201
                                ],
                                [
                                    -80.8868,
                                    -5.8202
                                ],
                                [
                                    -80.8885,
                                    -5.8198
                                ],
                                [
                                    -80.8917,
                                    -5.8199
                                ],
                                [
                                    -80.8945,
                                    -5.8221
                                ],
                                [
                                    -80.8966,
                                    -5.825
                                ],
                                [
                                    -80.8982,
                                    -5.8268
                                ],
                                [
                                    -80.9,
                                    -5.8276
                                ],
                                [
                                    -80.9027,
                                    -5.8307
                                ],
                                [
                                    -80.9058,
                                    -5.8333
                                ],
                                [
                                    -80.9067,
                                    -5.8349
                                ],
                                [
                                    -80.9083,
                                    -5.8357
                                ],
                                [
                                    -80.9118,
                                    -5.8382
                                ],
                                [
                                    -80.9146,
                                    -5.8396
                                ],
                                [
                                    -80.9167,
                                    -5.8407
                                ],
                                [
                                    -80.9193,
                                    -5.836
                                ]
                            ]
                        },
                        "properties": {
                            "value": 0.05
                        },
                        "id": "5"
                    },
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "LineString",
                            "coordinates": [
                                [
                                    -80.8755,
                                    -5.525
                                ],
                                [
                                    -80.8754,
                                    -5.5246
                                ],
                                [
                                    -80.875,
                                    -5.5243
                                ],
                                [
                                    -80.8746,
                                    -5.5246
                                ],
                                [
                                    -80.8741,
                                    -5.525
                                ],
                                [
                                    -80.8742,
                                    -5.5258
                                ],
                                [
                                    -80.875,
                                    -5.5264
                                ],
                                [
                                    -80.8754,
                                    -5.5254
                                ],
                                [
                                    -80.8755,
                                    -5.525
                                ]
                            ]
                        },
                        "properties": {
                            "value": 0.05
                        },
                        "id": "6"
                    },
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "LineString",
                            "coordinates": [
                                [
                                    -80.8707,
                                    -6.4333
                                ],
                                [
                                    -80.8694,
                                    -6.4361
                                ],
                                [
                                    -80.8667,
                                    -6.4375
                                ],
                                [
                                    -80.8644,
                                    -6.4394
                                ],
                                [
                                    -80.8633,
                                    -6.4417
                                ],
                                [
                                    -80.8617,
                                    -6.445
                                ],
                                [
                                    -80.8583,
                                    -6.4467
                                ],
                                [
                                    -80.8565,
                                    -6.4482
                                ],
                                [
                                    -80.8563,
                                    -6.45
                                ],
                                [
                                    -80.8568,
                                    -6.4516
                                ],
                                [
                                    -80.8583,
                                    -6.4529
                                ],
                                [
                                    -80.8619,
                                    -6.4547
                                ],
                                [
                                    -80.8638,
                                    -6.4583
                                ],
                                [
                                    -80.8639,
                                    -6.4611
                                ],
                                [
                                    -80.8639,
                                    -6.4639
                                ],
                                [
                                    -80.864,
                                    -6.4667
                                ],
                                [
                                    -80.8622,
                                    -6.4705
                                ],
                                [
                                    -80.8583,
                                    -6.4725
                                ],
                                [
                                    -80.8558,
                                    -6.4724
                                ],
                                [
                                    -80.8526,
                                    -6.4724
                                ],
                                [
                                    -80.85,
                                    -6.4724
                                ],
                                [
                                    -80.8462,
                                    -6.4705
                                ],
                                [
                                    -80.8443,
                                    -6.4667
                                ],
                                [
                                    -80.844,
                                    -6.4643
                                ],
                                [
                                    -80.8441,
                                    -6.4607
                                ],
                                [
                                    -80.8438,
                                    -6.4583
                                ],
                                [
                                    -80.8437,
                                    -6.4563
                                ],
                                [
                                    -80.8437,
                                    -6.4521
                                ],
                                [
                                    -80.8436,
                                    -6.45
                                ],
                                [
                                    -80.8441,
                                    -6.4476
                                ],
                                [
                                    -80.8441,
                                    -6.4441
                                ],
                                [
                                    -80.8449,
                                    -6.4417
                                ],
                                [
                                    -80.8439,
                                    -6.4394
                                ],
                                [
                                    -80.8417,
                                    -6.4383
                                ],
                                [
                                    -80.8384,
                                    -6.4366
                                ],
                                [
                                    -80.8367,
                                    -6.4333
                                ],
                                [
                                    -80.8384,
                                    -6.4301
                                ],
                                [
                                    -80.8417,
                                    -6.4285
                                ],
                                [
                                    -80.8441,
                                    -6.4274
                                ],
                                [
                                    -80.8454,
                                    -6.425
                                ],
                                [
                                    -80.847,
                                    -6.422
                                ],
                                [
                                    -80.85,
                                    -6.4205
                                ],
                                [
                                    -80.8524,
                                    -6.4191
                                ],
                                [
                                    -80.8532,
                                    -6.4167
                                ],
                                [
                                    -80.8526,
                                    -6.414
                                ],
                                [
                                    -80.8527,
                                    -6.411
                                ],
                                [
                                    -80.8523,
                                    -6.4083
                                ],
                                [
                                    -80.8523,
                                    -6.406
                                ],
                                [
                                    -80.8523,
                                    -6.4023
                                ],
                                [
                                    -80.8524,
                                    -6.4
                                ],
                                [
                                    -80.8524,
                                    -6.3976
                                ],
                                [
                                    -80.8524,
                                    -6.3941
                                ],
                                [
                                    -80.8524,
                                    -6.3917
                                ],
                                [
                                    -80.8525,
                                    -6.3892
                                ],
                                [
                                    -80.85,
                                    -6.3892
                                ],
                                [
                                    -80.8461,
                                    -6.3872
                                ],
                                [
                                    -80.8442,
                                    -6.3833
                                ],
                                [
                                    -80.8461,
                                    -6.3795
                                ],
                                [
                                    -80.85,
                                    -6.3776
                                ],
                                [
                                    -80.8538,
                                    -6.3795
                                ],
                                [
                                    -80.8558,
                                    -6.3833
                                ],
                                [
                                    -80.8558,
                                    -6.3859
                                ],
                                [
                                    -80.8583,
                                    -6.3859
                                ],
                                [
                                    -80.8622,
                                    -6.3878
                                ],
                                [
                                    -80.8642,
                                    -6.3917
                                ],
                                [
                                    -80.8642,
                                    -6.3941
                                ],
                                [
                                    -80.8642,
                                    -6.3975
                                ],
                                [
                                    -80.8642,
                                    -6.4
                                ],
                                [
                                    -80.8643,
                                    -6.4024
                                ],
                                [
                                    -80.8643,
                                    -6.406
                                ],
                                [
                                    -80.8643,
                                    -6.4083
                                ],
                                [
                                    -80.8639,
                                    -6.4111
                                ],
                                [
                                    -80.864,
                                    -6.414
                                ],
                                [
                                    -80.8634,
                                    -6.4167
                                ],
                                [
                                    -80.8631,
                                    -6.4202
                                ],
                                [
                                    -80.8632,
                                    -6.4215
                                ],
                                [
                                    -80.8628,
                                    -6.425
                                ],
                                [
                                    -80.8643,
                                    -6.4274
                                ],
                                [
                                    -80.8667,
                                    -6.4293
                                ],
                                [
                                    -80.8693,
                                    -6.4307
                                ],
                                [
                                    -80.8707,
                                    -6.4333
                                ]
                            ]
                        },
                        "properties": {
                            "value": 0.05
                        },
                        "id": "7"
                    }
                ]
            }
        }]
    };

    await sleep(1000);

console.log('executing ...')
    const response = await axios.post(`http://localhost:${port}/scenarios/Peru/steps/${stepId}/execute`, state);
    const ticket = response.data.ticket;

    let poll: any;
    do {
        await sleep(1000); console.log('polling ...')
        poll = await axios.get(`http://localhost:${port}/scenarios/Peru/steps/${stepId}/execute/poll/${ticket}`);
    } while (poll.data.ticket);
    const results = poll.data.results;

    expect(results).toBeTruthy();
    expect(results.data).toBeTruthy();

    const result = results.data.find((r: DatumReference) => r.id === 'eqDamage')
    expect(result.id).toBe('eqDamage');
    expect(result.reference);
    
    const fileResponse = await axios.get(`http://localhost:${port}/files/${result.reference}`);
    const data = fileResponse.data;
    // expect(data).toBeTruthy();
    // expect(data.type).toBe('FeatureCollection');
    // expect(data.features[0]);
    // expect(data.features[0].id);
    // expect(data.features[0].type).toBe('Feature');
    // expect(data.features[0].geometry);
    expect(data.features[0].properties);
}, 60000);

