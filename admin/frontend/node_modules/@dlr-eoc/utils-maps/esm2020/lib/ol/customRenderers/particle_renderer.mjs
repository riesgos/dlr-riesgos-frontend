import LayerRenderer from 'ol/renderer/Layer';
import VectorLayer from 'ol/layer/Vector';
import Delaunator from 'delaunator';
import { Shader, Framebuffer, Program, Uniform, Texture, renderLoop, Attribute } from '../../webgl/engine.core';
import { rectangleA } from '../../webgl/engine.shapes';
import { flattenRecursive } from '../../webgl/utils';
export class WindFieldLayer extends VectorLayer {
    constructor(options) {
        super(options);
    }
    createRenderer() {
        return new ParticleRenderer(this);
    }
    startAnimation(fps) {
        // @ts-ignore
        this.getRenderer().startAnimation(fps);
    }
}
/**
 * This renderer illustrates how WebGL can be used to to pixel-by-pixel calculations
 * that would be too expensive on a CPU but are easily done on a GPU.
 * In our shader we go through every pixel and calculate its new state from
 * its old state and that of it's environment.
 *
 * Note how similar in principle this is to Conway's Game of Life: one pixel's state is determined
 * by its surroundings from the time-step before.
 *
 * This renderer also illustrates another common technique in WebGL: `framebuffer-ping-pong`.
 * This is where the output of one shader is stored on a framebuffer and then passed to a subsequent shader.
 * With this, we can create a multi-step-pipeline, where each shader uses the previous
 * one's output as its own input.
 */
export class ParticleRenderer extends LayerRenderer {
    constructor(layer) {
        super(layer);
        this.fps = 30;
        // setting up canvas
        const canvas = document.createElement('canvas');
        canvas.width = 1000;
        canvas.height = 1000;
        canvas.style.position = 'absolute';
        // preparing data
        const source = layer.getSource();
        const features = source.getFeatures();
        const aObservation = this.pointsToObservations(features);
        const gl = canvas.getContext('webgl');
        const rect = rectangleA(2.0, 2.0);
        // --------- Step 1: interpolating field between data points. ------------------------------------------
        const interpolProgram = new Program(gl, `
            attribute vec4 a_observation;
            uniform mat3 u_world2pix;
            uniform mat3 u_pix2canv;
            varying vec2 v_value;

            void main() {
                vec3 pixelPosition = u_world2pix * vec3(a_observation.x, a_observation.y, 1.);
                vec3 canvasPosition = u_pix2canv * pixelPosition;
                v_value = (a_observation.zw / 2.0) + 0.5;
                gl_Position = vec4(canvasPosition.xy, 0.0, 1.0);
            }
        `, `
            precision mediump float;
            varying vec2 v_value;

            void main() {
                gl_FragColor = vec4(v_value.xy, 0.0, 1.0);
            }
        `);
        const interpolShader = new Shader(interpolProgram, [
            new Attribute(gl, interpolProgram, 'a_observation', aObservation)
        ], [
            new Uniform(gl, interpolProgram, 'u_world2pix', 'mat3', flattenRecursive([
                [1., 0., 0.],
                [0., 1., 0.],
                [0., 0., 1.]
            ])),
            new Uniform(gl, interpolProgram, 'u_pix2canv', 'mat3', flattenRecursive([
                [1. / (canvas.width / 2), 0., 0.],
                [0, -1. / (canvas.height / 2), 0.],
                [-1., 1., 1.]
            ]))
        ], []);
        const interpolFb = new Framebuffer(gl, canvas.width, canvas.height);
        // ------------------ Step 2: moving particles along force field ------------------------------------
        const particleFb1 = new Framebuffer(gl, canvas.width, canvas.height);
        const particleFb2 = new Framebuffer(gl, canvas.width, canvas.height);
        const particleProgram = new Program(gl, `
            attribute vec3 a_vertex;
            attribute vec2 a_textureCoord;
            varying vec2 v_textureCoord;
            void main() {
                v_textureCoord = a_textureCoord;
                gl_Position = vec4(a_vertex.xyz, 1.0);
            }
        `, `
        precision mediump float;
        uniform sampler2D u_forceTexture;
        uniform sampler2D u_particleTexture;
        uniform float u_deltaT;
        varying vec2 v_textureCoord;

        float rand(vec2 co){
            return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);
        }

        void main() {
            // moving particles
            vec2 speed = ((texture2D(u_forceTexture, v_textureCoord) - 0.5 ) * 2.0).xy;
            vec2 samplePoint = v_textureCoord - speed * u_deltaT * 0.1;
            samplePoint = mod(samplePoint, 1.0);
            gl_FragColor = texture2D(u_particleTexture, samplePoint);

            // fade out
            float fadeRate = 0.95;
            if (gl_FragColor.x != 1.0) {
                vec4 lastColor = texture2D(u_particleTexture, v_textureCoord);
                vec4 fadedColor = vec4(lastColor.xyz * fadeRate, 1.0);
                gl_FragColor = fadedColor;
            }

            // spawn and die-off
            float spawnChance = 0.0005;
            float dieChance = 0.2;
            float randVal = rand(v_textureCoord * abs(sin(u_deltaT)) * 0.01);
            if (randVal > (1. - spawnChance)) {  // spawn
                gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);
            } if (randVal < dieChance) {   // die off
                gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
            }

            // no particles outside texture
            if (texture2D(u_forceTexture, v_textureCoord) == vec4(0.0, 0.0, 0.0, 0.0)) {
                gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
            }
        }
        `);
        const particleShader = new Shader(particleProgram, [
            new Attribute(gl, particleProgram, 'a_vertex', rect.vertices),
            new Attribute(gl, particleProgram, 'a_textureCoord', rect.texturePositions)
        ], [
            new Uniform(gl, particleProgram, 'u_deltaT', 'float', [0.01])
        ], [
            new Texture(gl, particleProgram, 'u_forceTexture', interpolFb.fbo.texture, 0),
            new Texture(gl, particleProgram, 'u_particleTexture', particleFb1.fbo.texture, 1)
        ]);
        // ------------------ Step 3: Mixing background-field and particles ------------------------------------
        const textureMixProgram = new Program(gl, `
            attribute vec3 a_vertex;
            attribute vec2 a_textureCoord;
            varying vec2 v_textureCoord;
            void main() {
                v_textureCoord = a_textureCoord;
                gl_Position = vec4(a_vertex.xyz, 1.0);
            }
        `, `
            precision mediump float;
            uniform sampler2D u_bgTexture;
            uniform sampler2D u_particleTexture;
            varying vec2 v_textureCoord;
            void main() {
                vec4 bgColor = texture2D(u_bgTexture, v_textureCoord);
                vec4 particleColor = texture2D(u_particleTexture, v_textureCoord);
                vec4 colorMix = max(particleColor, bgColor);
                gl_FragColor = colorMix;
            }
        `);
        const textureMixShader = new Shader(textureMixProgram, [
            new Attribute(gl, textureMixProgram, 'a_vertex', rect.vertices),
            new Attribute(gl, textureMixProgram, 'a_textureCoord', rect.texturePositions)
        ], [], [
            new Texture(gl, textureMixProgram, 'u_bgTexture', interpolFb.fbo.texture, 0),
            new Texture(gl, textureMixProgram, 'u_particleTexture', particleFb1.fbo.texture, 1)
        ]);
        // Setup
        interpolShader.bind(gl);
        interpolShader.render(gl, [0, 0, 0, 0], interpolFb.fbo);
        textureMixShader.bind(gl);
        textureMixShader.render(gl);
        particleShader.bind(gl);
        // making data available for later
        this.canvas = canvas;
        this.gl = gl;
        this.interpolationShader = interpolShader;
        this.particleShader = particleShader;
        this.textureMixShader = textureMixShader;
        this.interpolFb = interpolFb;
        this.particleFb1 = particleFb1;
        this.particleFb2 = particleFb2;
    }
    /**
     * We could also have just started the animation right in the constructor.
     * Instead we created a separate `startAnimation` function so that it can optionally be run outside angular's zone,
     * preventing it from firing too many change cycles.
     * We leave this decision to the user, however, because it is not an ol-renderers duty to handle any angular-logic.
     */
    startAnimation(fps) {
        this.fps = fps;
        // Animation loop
        let i = 0;
        let fbIn;
        let fbOut;
        renderLoop(this.fps, (deltaT) => {
            i += 1;
            // framebuffer ping-pong
            if (i % 2 === 1) {
                fbIn = this.particleFb1;
                fbOut = this.particleFb2;
            }
            else {
                fbIn = this.particleFb2;
                fbOut = this.particleFb1;
            }
            // particle shader
            this.particleShader.textures[1].texture = fbIn.fbo.texture;
            this.particleShader.updateUniformData(this.gl, 'u_deltaT', [deltaT]);
            this.particleShader.bind(this.gl);
            this.particleShader.render(this.gl, null, fbOut.fbo);
            // texture to output
            this.textureMixShader.textures[1].texture = fbOut.fbo.texture;
            this.textureMixShader.bind(this.gl);
            this.textureMixShader.render(this.gl);
        });
    }
    stopAnimation() {
        this.fps = 0;
    }
    prepareFrame(frameState) {
        const layerState = frameState.layerStatesArray[frameState.layerIndex];
        const size = frameState.size;
        const opacity = layerState.opacity;
        if (size[0] !== this.canvas.width || size[1] !== this.canvas.height) {
            this.canvas.width = size[0];
            this.canvas.height = size[1];
        }
        this.canvas.style.opacity = `${opacity}`;
        // update world2pix
        const c2pT = frameState.coordinateToPixelTransform;
        const worldToPixelTransform = [
            [c2pT[0], c2pT[1], 0.],
            [c2pT[2], c2pT[3], 0.],
            [c2pT[4], c2pT[5], 1.]
        ];
        this.interpolationShader.updateUniformData(this.gl, 'u_world2pix', flattenRecursive(worldToPixelTransform));
        // update pix2canvas
        const pix2canv = [
            [1. / (this.canvas.width / 2), 0., 0.],
            [0, -1. / (this.canvas.height / 2), 0.],
            [-1., 1., 1.]
        ];
        this.interpolationShader.updateUniformData(this.gl, 'u_pix2canv', flattenRecursive(pix2canv));
        // bind new data and render
        this.interpolationShader.bind(this.gl);
        this.interpolationShader.render(this.gl, [0, 0, 0, 0], this.interpolFb.fbo);
        return true;
    }
    renderFrame(frameState, target) {
        return this.canvas;
    }
    renderDeclutter(frameState) {
    }
    pointsToObservations(features) {
        const pointToObservation = (feature) => {
            const coords = feature.getGeometry().getCoordinates();
            const props = feature.getProperties();
            return [coords[0], coords[1], props.wind[0], props.wind[1]];
        };
        const coordinates = features.map(f => f.getGeometry().getCoordinates());
        const delauney = Delaunator.from(coordinates);
        const indices = delauney.triangles;
        const aObservations = [];
        for (const i of indices) {
            const o = pointToObservation(features[i]);
            aObservations.push(o);
        }
        return aObservations;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFydGljbGVfcmVuZGVyZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy91dGlscy1tYXBzL3NyYy9saWIvb2wvY3VzdG9tUmVuZGVyZXJzL3BhcnRpY2xlX3JlbmRlcmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sYUFBYSxNQUFNLG1CQUFtQixDQUFDO0FBQzlDLE9BQU8sV0FBVyxNQUFNLGlCQUFpQixDQUFDO0FBSTFDLE9BQU8sVUFBVSxNQUFNLFlBQVksQ0FBQztBQUNwQyxPQUFPLEVBQUUsTUFBTSxFQUFFLFdBQVcsRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxVQUFVLEVBQUUsU0FBUyxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDaEgsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBR3JELE1BQU0sT0FBTyxjQUFlLFNBQVEsV0FBbUM7SUFDbkUsWUFBWSxPQUFPO1FBQ2YsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ25CLENBQUM7SUFFRCxjQUFjO1FBQ1YsT0FBTyxJQUFJLGdCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3RDLENBQUM7SUFFRCxjQUFjLENBQUMsR0FBVztRQUN0QixhQUFhO1FBQ1osSUFBSSxDQUFDLFdBQVcsRUFBdUIsQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDakUsQ0FBQztDQUNKO0FBRUQ7Ozs7Ozs7Ozs7Ozs7R0FhRztBQUNILE1BQU0sT0FBTyxnQkFBaUIsU0FBUSxhQUFrRDtJQWFwRixZQUFZLEtBQTBDO1FBQ2xELEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUhULFFBQUcsR0FBRyxFQUFFLENBQUM7UUFLYixvQkFBb0I7UUFDcEIsTUFBTSxNQUFNLEdBQUcsUUFBUSxDQUFDLGFBQWEs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LEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxjQUFjLEVBQUUsQ0FBQyxDQUFDO1FBQ3hFLE1BQU0sUUFBUSxHQUFHLFVBQVUsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDOUMsTUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDLFNBQVMsQ0FBQztRQUNuQyxNQUFNLGFBQWEsR0FBRyxFQUFFLENBQUM7UUFDekIsS0FBSyxNQUFNLENBQUMsSUFBSSxPQUFPLEVBQUU7WUFDckIsTUFBTSxDQUFDLEdBQUcsa0JBQWtCLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDMUMsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUN6QjtRQUVELE9BQU8sYUFBYSxDQUFDO0lBQ3pCLENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEZlYXR1cmUgfSBmcm9tICdvbCc7XG5pbXBvcnQgeyBGcmFtZVN0YXRlIH0gZnJvbSAnb2wvUGx1Z2dhYmxlTWFwJztcbmltcG9ydCBMYXllclJlbmRlcmVyIGZyb20gJ29sL3JlbmRlcmVyL0xheWVyJztcbmltcG9ydCBWZWN0b3JMYXllciBmcm9tICdvbC9sYXllci9WZWN0b3InO1xuaW1wb3J0IEdlb21ldHJ5IGZyb20gJ29sL2dlb20vR2VvbWV0cnknO1xuaW1wb3J0IHsgVmVjdG9yIGFzIFZlY3RvclNvdXJjZSB9IGZyb20gJ29sL3NvdXJjZSc7XG5pbXBvcnQgUG9pbnQgZnJvbSAnb2wvZ2VvbS9Qb2ludCc7XG5pbXBvcnQgRGVsYXVuYXRvciBmcm9tICdkZWxhdW5hdG9yJztcbmltcG9ydCB7IFNoYWRlciwgRnJhbWVidWZmZXIsIFByb2dyYW0sIFVuaWZvcm0sIFRleHR1cmUsIHJlbmRlckxvb3AsIEF0dHJpYnV0ZSB9IGZyb20gJy4uLy4uL3dlYmdsL2VuZ2luZS5jb3JlJztcbmltcG9ydCB7IHJlY3RhbmdsZUEgfSBmcm9tICcuLi8uLi93ZWJnbC9lbmdpbmUuc2hhcGVzJztcbmltcG9ydCB7IGZsYXR0ZW5SZWN1cnNpdmUgfSBmcm9tICcuLi8uLi93ZWJnbC91dGlscyc7XG5cblxuZXhwb3J0IGNsYXNzIFdpbmRGaWVsZExheWVyIGV4dGVuZHMgVmVjdG9yTGF5ZXI8VmVjdG9yU291cmNlPEdlb21ldHJ5Pj4ge1xuICAgIGNvbnN0cnVjdG9yKG9wdGlvbnMpIHtcbiAgICAgICAgc3VwZXIob3B0aW9ucyk7XG4gICAgfVxuXG4gICAgY3JlYXRlUmVuZGVyZXIoKTogUGFydGljbGVSZW5kZXJlciB7XG4gICAgICAgIHJldHVybiBuZXcgUGFydGljbGVSZW5kZXJlcih0aGlzKTtcbiAgICB9XG5cbiAgICBzdGFydEFuaW1hdGlvbihmcHM6IG51bWJlcik6IHZvaWQge1xuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICh0aGlzLmdldFJlbmRlcmVyKCkgYXMgUGFydGljbGVSZW5kZXJlcikuc3RhcnRBbmltYXRpb24oZnBzKTtcbiAgICB9XG59XG5cbi8qKlxuICogVGhpcyByZW5kZXJlciBpbGx1c3RyYXRlcyBob3cgV2ViR0wgY2FuIGJlIHVzZWQgdG8gdG8gcGl4ZWwtYnktcGl4ZWwgY2FsY3VsYXRpb25zXG4gKiB0aGF0IHdvdWxkIGJlIHRvbyBleHBlbnNpdmUgb24gYSBDUFUgYnV0IGFyZSBlYXNpbHkgZG9uZSBvbiBhIEdQVS5cbiAqIEluIG91ciBzaGFkZXIgd2UgZ28gdGhyb3VnaCBldmVyeSBwaXhlbCBhbmQgY2FsY3VsYXRlIGl0cyBuZXcgc3RhdGUgZnJvbVxuICogaXRzIG9sZCBzdGF0ZSBhbmQgdGhhdCBvZiBpdCdzIGVudmlyb25tZW50LlxuICpcbiAqIE5vdGUgaG93IHNpbWlsYXIgaW4gcHJpbmNpcGxlIHRoaXMgaXMgdG8gQ29ud2F5J3MgR2FtZSBvZiBMaWZlOiBvbmUgcGl4ZWwncyBzdGF0ZSBpcyBkZXRlcm1pbmVkXG4gKiBieSBpdHMgc3Vycm91bmRpbmdzIGZyb20gdGhlIHRpbWUtc3RlcCBiZWZvcmUuXG4gKlxuICogVGhpcyByZW5kZXJlciBhbHNvIGlsbHVzdHJhdGVzIGFub3RoZXIgY29tbW9uIHRlY2huaXF1ZSBpbiBXZWJHTDogYGZyYW1lYnVmZmVyLXBpbmctcG9uZ2AuXG4gKiBUaGlzIGlzIHdoZXJlIHRoZSBvdXRwdXQgb2Ygb25lIHNoYWRlciBpcyBzdG9yZWQgb24gYSBmcmFtZWJ1ZmZlciBhbmQgdGhlbiBwYXNzZWQgdG8gYSBzdWJzZXF1ZW50IHNoYWRlci5cbiAqIFdpdGggdGhpcywgd2UgY2FuIGNyZWF0ZSBhIG11bHRpLXN0ZXAtcGlwZWxpbmUsIHdoZXJlIGVhY2ggc2hhZGVyIHVzZXMgdGhlIHByZXZpb3VzXG4gKiBvbmUncyBvdXRwdXQgYXMgaXRzIG93biBpbnB1dC5cbiAqL1xuZXhwb3J0IGNsYXNzIFBhcnRpY2xlUmVuZGVyZXIgZXh0ZW5kcyBMYXllclJlbmRlcmVyPFZlY3RvckxheWVyPFZlY3RvclNvdXJjZTxHZW9tZXRyeT4+PiB7XG5cblxuICAgIHJlYWRvbmx5IGNhbnZhczogSFRNTENhbnZhc0VsZW1lbnQ7XG4gICAgcmVhZG9ubHkgZ2w6IFdlYkdMUmVuZGVyaW5nQ29udGV4dDtcbiAgICByZWFkb25seSBpbnRlcnBvbGF0aW9uU2hhZGVyOiBTaGFkZXI7XG4gICAgcmVhZG9ubHkgcGFydGljbGVTaGFkZXI6IFNoYWRlcjtcbiAgICByZWFkb25seSB0ZXh0dXJlTWl4U2hhZGVyOiBTaGFkZXI7XG4gICAgcmVhZG9ubHkgaW50ZXJwb2xGYjogRnJhbWVidWZmZXI7XG4gICAgcmVhZG9ubHkgcGFydGljbGVGYjE6IEZyYW1lYnVmZmVyO1xuICAgIHJlYWRvbmx5IHBhcnRpY2xlRmIyOiBGcmFtZWJ1ZmZlcjtcbiAgICBwcml2YXRlIGZwcyA9IDMwO1xuXG4gICAgY29uc3RydWN0b3IobGF5ZXI6IFZlY3RvckxheWVyPFZlY3RvclNvdXJjZTxHZW9tZXRyeT4+KSB7XG4gICAgICAgIHN1cGVyKGxheWVyKTtcblxuICAgICAgICAvLyBzZXR0aW5nIHVwIGNhbnZhc1xuICAgICAgICBjb25zdCBjYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTtcbiAgICAgICAgY2FudmFzLndpZHRoID0gMTAwMDtcbiAgICAgICAgY2FudmFzLmhlaWdodCA9IDEwMDA7XG4gICAgICAgIGNhbnZhcy5zdHlsZS5wb3NpdGlvbiA9ICdhYnNvbHV0ZSc7XG5cblxuICAgICAgICAvLyBwcmVwYXJpbmcgZGF0YVxuICAgICAgICBjb25zdCBzb3VyY2UgPSBsYXllci5nZXRTb3VyY2UoKTtcbiAgICAgICAgY29uc3QgZmVhdHVyZXMgPSBzb3VyY2UuZ2V0RmVhdHVyZXMoKSBhcyBGZWF0dXJlPFBvaW50PltdO1xuICAgICAgICBjb25zdCBhT2JzZXJ2YXRpb24gPSB0aGlzLnBvaW50c1RvT2JzZXJ2YXRpb25zKGZlYXR1cmVzKTtcblxuICAgICAgICBjb25zdCBnbCA9IGNhbnZhcy5nZXRDb250ZXh0KCd3ZWJnbCcpO1xuICAgICAgICBjb25zdCByZWN0ID0gcmVjdGFuZ2xlQSgyLjAsIDIuMCk7XG5cblxuXG4gICAgICAgIC8vIC0tLS0tLS0tLSBTdGVwIDE6IGludGVycG9sYXRpbmcgZmllbGQgYmV0d2VlbiBkYXRhIHBvaW50cy4gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbiAgICAgICAgY29uc3QgaW50ZXJwb2xQcm9ncmFtID0gbmV3IFByb2dyYW0oZ2wsIGBcbiAgICAgICAgICAgIGF0dHJpYnV0ZSB2ZWM0IGFfb2JzZXJ2YXRpb247XG4gICAgICAgICAgICB1bmlmb3JtIG1hdDMgdV93b3JsZDJwaXg7XG4gICAgICAgICAgICB1bmlmb3JtIG1hdDMgdV9waXgyY2FudjtcbiAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2X3ZhbHVlO1xuXG4gICAgICAgICAgICB2b2lkIG1haW4oKSB7XG4gICAgICAgICAgICAgICAgdmVjMyBwaXhlbFBvc2l0aW9uID0gdV93b3JsZDJwaXggKiB2ZWMzKGFfb2JzZXJ2YXRpb24ueCwgYV9vYnNlcnZhdGlvbi55LCAxLik7XG4gICAgICAgICAgICAgICAgdmVjMyBjYW52YXNQb3NpdGlvbiA9IHVfcGl4MmNhbnYgKiBwaXhlbFBvc2l0aW9uO1xuICAgICAgICAgICAgICAgIHZfdmFsdWUgPSAoYV9vYnNlcnZhdGlvbi56dyAvIDIuMCkgKyAwLjU7XG4gICAgICAgICAgICAgICAgZ2xfUG9zaXRpb24gPSB2ZWM0KGNhbnZhc1Bvc2l0aW9uLnh5LCAwLjAsIDEuMCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIGAsIGBcbiAgICAgICAgICAgIHByZWNpc2lvbiBtZWRpdW1wIGZsb2F0O1xuICAgICAgICAgICAgdmFyeWluZyB2ZWMyIHZfdmFsdWU7XG5cbiAgICAgICAgICAgIHZvaWQgbWFpbigpIHtcbiAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KHZfdmFsdWUueHksIDAuMCwgMS4wKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgYCk7XG5cbiAgICAgICAgY29uc3QgaW50ZXJwb2xTaGFkZXIgPSBuZXcgU2hhZGVyKGludGVycG9sUHJvZ3JhbSwgW1xuICAgICAgICAgICAgbmV3IEF0dHJpYnV0ZShnbCwgaW50ZXJwb2xQcm9ncmFtLCAnYV9vYnNlcnZhdGlvbicsIGFPYnNlcnZhdGlvbilcbiAgICAgICAgXSwgW1xuICAgICAgICAgICAgbmV3IFVuaWZvcm0oZ2wsIGludGVycG9sUHJvZ3JhbSwgJ3Vfd29ybGQycGl4JywgJ21hdDMnLCBmbGF0dGVuUmVjdXJzaXZlKFtcbiAgICAgICAgICAgICAgICBbMS4sIDAuLCAwLl0sXG4gICAgICAgICAgICAgICAgWzAuLCAxLiwgMC5dLFxuICAgICAgICAgICAgICAgIFswLiwgMC4sIDEuXVxuICAgICAgICAgICAgXSkpLFxuICAgICAgICAgICAgbmV3IFVuaWZvcm0oZ2wsIGludGVycG9sUHJvZ3JhbSwgJ3VfcGl4MmNhbnYnLCAnbWF0MycsIGZsYXR0ZW5SZWN1cnNpdmUoW1xuICAgICAgICAgICAgICAgIFsxLiAvICAoY2FudmFzLndpZHRoIC8gMiksICAwLiwgICAgICAgICAgICAgICAgICAgICAgICAwLiBdLFxuICAgICAgICAgICAgICAgIFswLCAgICAgICAgICAgICAgICAgICAgICAgIC0xLiAvIChjYW52YXMuaGVpZ2h0IC8gMiksICAwLiBdLFxuICAgICAgICAgICAgICAgIFstMS4sICAgICAgICAgICAgICAgICAgICAgIDEuLCAgICAgICAgICAgICAgICAgICAgICAgICAxLiBdXG4gICAgICAgICAgICBdKSlcbiAgICAgICAgXSwgW10pO1xuXG4gICAgICAgIGNvbnN0IGludGVycG9sRmIgPSBuZXcgRnJhbWVidWZmZXIoZ2wsIGNhbnZhcy53aWR0aCwgY2FudmFzLmhlaWdodCk7XG5cblxuXG5cbiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tIFN0ZXAgMjogbW92aW5nIHBhcnRpY2xlcyBhbG9uZyBmb3JjZSBmaWVsZCAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuICAgICAgICBjb25zdCBwYXJ0aWNsZUZiMSA9IG5ldyBGcmFtZWJ1ZmZlcihnbCwgY2FudmFzLndpZHRoLCBjYW52YXMuaGVpZ2h0KTtcbiAgICAgICAgY29uc3QgcGFydGljbGVGYjIgPSBuZXcgRnJhbWVidWZmZXIoZ2wsIGNhbnZhcy53aWR0aCwgY2FudmFzLmhlaWdodCk7XG5cbiAgICAgICAgY29uc3QgcGFydGljbGVQcm9ncmFtID0gbmV3IFByb2dyYW0oZ2wsIGBcbiAgICAgICAgICAgIGF0dHJpYnV0ZSB2ZWMzIGFfdmVydGV4O1xuICAgICAgICAgICAgYXR0cmlidXRlIHZlYzIgYV90ZXh0dXJlQ29vcmQ7XG4gICAgICAgICAgICB2YXJ5aW5nIHZlYzIgdl90ZXh0dXJlQ29vcmQ7XG4gICAgICAgICAgICB2b2lkIG1haW4oKSB7XG4gICAgICAgICAgICAgICAgdl90ZXh0dXJlQ29vcmQgPSBhX3RleHR1cmVDb29yZDtcbiAgICAgICAgICAgICAgICBnbF9Qb3NpdGlvbiA9IHZlYzQoYV92ZXJ0ZXgueHl6LCAxLjApO1xuICAgICAgICAgICAgfVxuICAgICAgICBgLCBgXG4gICAgICAgIHByZWNpc2lvbiBtZWRpdW1wIGZsb2F0O1xuICAgICAgICB1bmlmb3JtIHNhbXBsZXIyRCB1X2ZvcmNlVGV4dHVyZTtcbiAgICAgICAgdW5pZm9ybSBzYW1wbGVyMkQgdV9wYXJ0aWNsZVRleHR1cmU7XG4gICAgICAgIHVuaWZvcm0gZmxvYXQgdV9kZWx0YVQ7XG4gICAgICAgIHZhcnlpbmcgdmVjMiB2X3RleHR1cmVDb29yZDtcblxuICAgICAgICBmbG9hdCByYW5kKHZlYzIgY28pe1xuICAgICAgICAgICAgcmV0dXJuIGZyYWN0KHNpbihkb3QoY28ueHkgLHZlYzIoMTIuOTg5OCw3OC4yMzMpKSkgKiA0Mzc1OC41NDUzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHZvaWQgbWFpbigpIHtcbiAgICAgICAgICAgIC8vIG1vdmluZyBwYXJ0aWNsZXNcbiAgICAgICAgICAgIHZlYzIgc3BlZWQgPSAoKHRleHR1cmUyRCh1X2ZvcmNlVGV4dHVyZSwgdl90ZXh0dXJlQ29vcmQpIC0gMC41ICkgKiAyLjApLnh5O1xuICAgICAgICAgICAgdmVjMiBzYW1wbGVQb2ludCA9IHZfdGV4dHVyZUNvb3JkIC0gc3BlZWQgKiB1X2RlbHRhVCAqIDAuMTtcbiAgICAgICAgICAgIHNhbXBsZVBvaW50ID0gbW9kKHNhbXBsZVBvaW50LCAxLjApO1xuICAgICAgICAgICAgZ2xfRnJhZ0NvbG9yID0gdGV4dHVyZTJEKHVfcGFydGljbGVUZXh0dXJlLCBzYW1wbGVQb2ludCk7XG5cbiAgICAgICAgICAgIC8vIGZhZGUgb3V0XG4gICAgICAgICAgICBmbG9hdCBmYWRlUmF0ZSA9IDAuOTU7XG4gICAgICAgICAgICBpZiAoZ2xfRnJhZ0NvbG9yLnggIT0gMS4wKSB7XG4gICAgICAgICAgICAgICAgdmVjNCBsYXN0Q29sb3IgPSB0ZXh0dXJlMkQodV9wYXJ0aWNsZVRleHR1cmUsIHZfdGV4dHVyZUNvb3JkKTtcbiAgICAgICAgICAgICAgICB2ZWM0IGZhZGVkQ29sb3IgPSB2ZWM0KGxhc3RDb2xvci54eXogKiBmYWRlUmF0ZSwgMS4wKTtcbiAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSBmYWRlZENvbG9yO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBzcGF3biBhbmQgZGllLW9mZlxuICAgICAgICAgICAgZmxvYXQgc3Bhd25DaGFuY2UgPSAwLjAwMDU7XG4gICAgICAgICAgICBmbG9hdCBkaWVDaGFuY2UgPSAwLjI7XG4gICAgICAgICAgICBmbG9hdCByYW5kVmFsID0gcmFuZCh2X3RleHR1cmVDb29yZCAqIGFicyhzaW4odV9kZWx0YVQpKSAqIDAuMDEpO1xuICAgICAgICAgICAgaWYgKHJhbmRWYWwgPiAoMS4gLSBzcGF3bkNoYW5jZSkpIHsgIC8vIHNwYXduXG4gICAgICAgICAgICAgICAgZ2xfRnJhZ0NvbG9yID0gdmVjNCgxLjAsIDEuMCwgMS4wLCAxLjApO1xuICAgICAgICAgICAgfSBpZiAocmFuZFZhbCA8IGRpZUNoYW5jZSkgeyAgIC8vIGRpZSBvZmZcbiAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KDAuMCwgMC4wLCAwLjAsIDAuMCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIG5vIHBhcnRpY2xlcyBvdXRzaWRlIHRleHR1cmVcbiAgICAgICAgICAgIGlmICh0ZXh0dXJlMkQodV9mb3JjZVRleHR1cmUsIHZfdGV4dHVyZUNvb3JkKSA9PSB2ZWM0KDAuMCwgMC4wLCAwLjAsIDAuMCkpIHtcbiAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KDAuMCwgMC4wLCAwLjAsIDAuMCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgYCk7XG5cbiAgICAgICAgY29uc3QgcGFydGljbGVTaGFkZXIgPSBuZXcgU2hhZGVyKHBhcnRpY2xlUHJvZ3JhbSwgW1xuICAgICAgICAgICAgbmV3IEF0dHJpYnV0ZShnbCwgcGFydGljbGVQcm9ncmFtLCAnYV92ZXJ0ZXgnLCByZWN0LnZlcnRpY2VzKSxcbiAgICAgICAgICAgIG5ldyBBdHRyaWJ1dGUoZ2wsIHBhcnRpY2xlUHJvZ3JhbSwgJ2FfdGV4dHVyZUNvb3JkJywgcmVjdC50ZXh0dXJlUG9zaXRpb25zKVxuICAgICAgICBdLCBbXG4gICAgICAgICAgICBuZXcgVW5pZm9ybShnbCwgcGFydGljbGVQcm9ncmFtLCAndV9kZWx0YVQnLCAnZmxvYXQnLCBbMC4wMV0pXG4gICAgICAgIF0sIFtcbiAgICAgICAgICAgIG5ldyBUZXh0dXJlKGdsLCBwYXJ0aWNsZVByb2dyYW0sICd1X2ZvcmNlVGV4dHVyZScsIGludGVycG9sRmIuZmJvLnRleHR1cmUsIDApLFxuICAgICAgICAgICAgbmV3IFRleHR1cmUoZ2wsIHBhcnRpY2xlUHJvZ3JhbSwgJ3VfcGFydGljbGVUZXh0dXJlJywgcGFydGljbGVGYjEuZmJvLnRleHR1cmUsIDEpXG4gICAgICAgIF0pO1xuXG5cblxuXG4gICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLSBTdGVwIDM6IE1peGluZyBiYWNrZ3JvdW5kLWZpZWxkIGFuZCBwYXJ0aWNsZXMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbiAgICAgICAgY29uc3QgdGV4dHVyZU1peFByb2dyYW0gPSBuZXcgUHJvZ3JhbShnbCwgYFxuICAgICAgICAgICAgYXR0cmlidXRlIHZlYzMgYV92ZXJ0ZXg7XG4gICAgICAgICAgICBhdHRyaWJ1dGUgdmVjMiBhX3RleHR1cmVDb29yZDtcbiAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2X3RleHR1cmVDb29yZDtcbiAgICAgICAgICAgIHZvaWQgbWFpbigpIHtcbiAgICAgICAgICAgICAgICB2X3RleHR1cmVDb29yZCA9IGFfdGV4dHVyZUNvb3JkO1xuICAgICAgICAgICAgICAgIGdsX1Bvc2l0aW9uID0gdmVjNChhX3ZlcnRleC54eXosIDEuMCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIGAsIGBcbiAgICAgICAgICAgIHByZWNpc2lvbiBtZWRpdW1wIGZsb2F0O1xuICAgICAgICAgICAgdW5pZm9ybSBzYW1wbGVyMkQgdV9iZ1RleHR1cmU7XG4gICAgICAgICAgICB1bmlmb3JtIHNhbXBsZXIyRCB1X3BhcnRpY2xlVGV4dHVyZTtcbiAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2X3RleHR1cmVDb29yZDtcbiAgICAgICAgICAgIHZvaWQgbWFpbigpIHtcbiAgICAgICAgICAgICAgICB2ZWM0IGJnQ29sb3IgPSB0ZXh0dXJlMkQodV9iZ1RleHR1cmUsIHZfdGV4dHVyZUNvb3JkKTtcbiAgICAgICAgICAgICAgICB2ZWM0IHBhcnRpY2xlQ29sb3IgPSB0ZXh0dXJlMkQodV9wYXJ0aWNsZVRleHR1cmUsIHZfdGV4dHVyZUNvb3JkKTtcbiAgICAgICAgICAgICAgICB2ZWM0IGNvbG9yTWl4ID0gbWF4KHBhcnRpY2xlQ29sb3IsIGJnQ29sb3IpO1xuICAgICAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IGNvbG9yTWl4O1xuICAgICAgICAgICAgfVxuICAgICAgICBgKTtcbiAgICAgICAgY29uc3QgdGV4dHVyZU1peFNoYWRlciA9IG5ldyBTaGFkZXIodGV4dHVyZU1peFByb2dyYW0sIFtcbiAgICAgICAgICAgIG5ldyBBdHRyaWJ1dGUoZ2wsIHRleHR1cmVNaXhQcm9ncmFtLCAnYV92ZXJ0ZXgnLCByZWN0LnZlcnRpY2VzKSxcbiAgICAgICAgICAgIG5ldyBBdHRyaWJ1dGUoZ2wsIHRleHR1cmVNaXhQcm9ncmFtLCAnYV90ZXh0dXJlQ29vcmQnLCByZWN0LnRleHR1cmVQb3NpdGlvbnMpXG4gICAgICAgIF0sIFtdLCBbXG4gICAgICAgICAgICBuZXcgVGV4dHVyZShnbCwgdGV4dHVyZU1peFByb2dyYW0sICd1X2JnVGV4dHVyZScsIGludGVycG9sRmIuZmJvLnRleHR1cmUsIDApLFxuICAgICAgICAgICAgbmV3IFRleHR1cmUoZ2wsIHRleHR1cmVNaXhQcm9ncmFtLCAndV9wYXJ0aWNsZVRleHR1cmUnLCBwYXJ0aWNsZUZiMS5mYm8udGV4dHVyZSwgMSlcbiAgICAgICAgXSk7XG5cblxuICAgICAgICAvLyBTZXR1cFxuICAgICAgICBpbnRlcnBvbFNoYWRlci5iaW5kKGdsKTtcbiAgICAgICAgaW50ZXJwb2xTaGFkZXIucmVuZGVyKGdsLCBbMCwgMCwgMCwgMF0sIGludGVycG9sRmIuZmJvKTtcbiAgICAgICAgdGV4dHVyZU1peFNoYWRlci5iaW5kKGdsKTtcbiAgICAgICAgdGV4dHVyZU1peFNoYWRlci5yZW5kZXIoZ2wpO1xuICAgICAgICBwYXJ0aWNsZVNoYWRlci5iaW5kKGdsKTtcblxuICAgICAgICAvLyBtYWtpbmcgZGF0YSBhdmFpbGFibGUgZm9yIGxhdGVyXG4gICAgICAgIHRoaXMuY2FudmFzID0gY2FudmFzO1xuICAgICAgICB0aGlzLmdsID0gZ2w7XG4gICAgICAgIHRoaXMuaW50ZXJwb2xhdGlvblNoYWRlciA9IGludGVycG9sU2hhZGVyO1xuICAgICAgICB0aGlzLnBhcnRpY2xlU2hhZGVyID0gcGFydGljbGVTaGFkZXI7XG4gICAgICAgIHRoaXMudGV4dHVyZU1peFNoYWRlciA9IHRleHR1cmVNaXhTaGFkZXI7XG4gICAgICAgIHRoaXMuaW50ZXJwb2xGYiA9IGludGVycG9sRmI7XG4gICAgICAgIHRoaXMucGFydGljbGVGYjEgPSBwYXJ0aWNsZUZiMTtcbiAgICAgICAgdGhpcy5wYXJ0aWNsZUZiMiA9IHBhcnRpY2xlRmIyO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFdlIGNvdWxkIGFsc28gaGF2ZSBqdXN0IHN0YXJ0ZWQgdGhlIGFuaW1hdGlvbiByaWdodCBpbiB0aGUgY29uc3RydWN0b3IuXG4gICAgICogSW5zdGVhZCB3ZSBjcmVhdGVkIGEgc2VwYXJhdGUgYHN0YXJ0QW5pbWF0aW9uYCBmdW5jdGlvbiBzbyB0aGF0IGl0IGNhbiBvcHRpb25hbGx5IGJlIHJ1biBvdXRzaWRlIGFuZ3VsYXIncyB6b25lLFxuICAgICAqIHByZXZlbnRpbmcgaXQgZnJvbSBmaXJpbmcgdG9vIG1hbnkgY2hhbmdlIGN5Y2xlcy5cbiAgICAgKiBXZSBsZWF2ZSB0aGlzIGRlY2lzaW9uIHRvIHRoZSB1c2VyLCBob3dldmVyLCBiZWNhdXNlIGl0IGlzIG5vdCBhbiBvbC1yZW5kZXJlcnMgZHV0eSB0byBoYW5kbGUgYW55IGFuZ3VsYXItbG9naWMuXG4gICAgICovXG4gICAgc3RhcnRBbmltYXRpb24oZnBzOiBudW1iZXIpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5mcHMgPSBmcHM7XG5cbiAgICAgICAgLy8gQW5pbWF0aW9uIGxvb3BcbiAgICAgICAgbGV0IGkgPSAwO1xuICAgICAgICBsZXQgZmJJbjtcbiAgICAgICAgbGV0IGZiT3V0O1xuICAgICAgICByZW5kZXJMb29wKHRoaXMuZnBzLCAoZGVsdGFUOiBudW1iZXIpID0+IHtcbiAgICAgICAgICAgIGkgKz0gMTtcblxuICAgICAgICAgICAgLy8gZnJhbWVidWZmZXIgcGluZy1wb25nXG4gICAgICAgICAgICBpZiAoaSAlIDIgPT09IDEpIHtcbiAgICAgICAgICAgICAgICBmYkluID0gdGhpcy5wYXJ0aWNsZUZiMTtcbiAgICAgICAgICAgICAgICBmYk91dCA9IHRoaXMucGFydGljbGVGYjI7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGZiSW4gPSB0aGlzLnBhcnRpY2xlRmIyO1xuICAgICAgICAgICAgICAgIGZiT3V0ID0gdGhpcy5wYXJ0aWNsZUZiMTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gcGFydGljbGUgc2hhZGVyXG4gICAgICAgICAgICB0aGlzLnBhcnRpY2xlU2hhZGVyLnRleHR1cmVzWzFdLnRleHR1cmUgPSBmYkluLmZiby50ZXh0dXJlO1xuICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZVNoYWRlci51cGRhdGVVbmlmb3JtRGF0YSh0aGlzLmdsLCAndV9kZWx0YVQnLCBbZGVsdGFUXSk7XG4gICAgICAgICAgICB0aGlzLnBhcnRpY2xlU2hhZGVyLmJpbmQodGhpcy5nbCk7XG4gICAgICAgICAgICB0aGlzLnBhcnRpY2xlU2hhZGVyLnJlbmRlcih0aGlzLmdsLCBudWxsLCBmYk91dC5mYm8pO1xuXG4gICAgICAgICAgICAvLyB0ZXh0dXJlIHRvIG91dHB1dFxuICAgICAgICAgICAgdGhpcy50ZXh0dXJlTWl4U2hhZGVyLnRleHR1cmVzWzFdLnRleHR1cmUgPSBmYk91dC5mYm8udGV4dHVyZTtcbiAgICAgICAgICAgIHRoaXMudGV4dHVyZU1peFNoYWRlci5iaW5kKHRoaXMuZ2wpO1xuICAgICAgICAgICAgdGhpcy50ZXh0dXJlTWl4U2hhZGVyLnJlbmRlcih0aGlzLmdsKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgc3RvcEFuaW1hdGlvbigpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5mcHMgPSAwO1xuICAgIH1cblxuXG4gICAgcHJlcGFyZUZyYW1lKGZyYW1lU3RhdGU6IEZyYW1lU3RhdGUpOiBib29sZWFuIHtcbiAgICAgICAgY29uc3QgbGF5ZXJTdGF0ZSA9IGZyYW1lU3RhdGUubGF5ZXJTdGF0ZXNBcnJheVtmcmFtZVN0YXRlLmxheWVySW5kZXhdO1xuICAgICAgICBjb25zdCBzaXplID0gZnJhbWVTdGF0ZS5zaXplO1xuICAgICAgICBjb25zdCBvcGFjaXR5ID0gbGF5ZXJTdGF0ZS5vcGFjaXR5O1xuICAgICAgICBpZiAoc2l6ZVswXSAhPT0gdGhpcy5jYW52YXMud2lkdGggfHwgc2l6ZVsxXSAhPT0gdGhpcy5jYW52YXMuaGVpZ2h0KSB7XG4gICAgICAgICAgICB0aGlzLmNhbnZhcy53aWR0aCA9IHNpemVbMF07XG4gICAgICAgICAgICB0aGlzLmNhbnZhcy5oZWlnaHQgPSBzaXplWzFdO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuY2FudmFzLnN0eWxlLm9wYWNpdHkgPSBgJHtvcGFjaXR5fWA7XG5cbiAgICAgICAgLy8gdXBkYXRlIHdvcmxkMnBpeFxuICAgICAgICBjb25zdCBjMnBUID0gZnJhbWVTdGF0ZS5jb29yZGluYXRlVG9QaXhlbFRyYW5zZm9ybTtcbiAgICAgICAgY29uc3Qgd29ybGRUb1BpeGVsVHJhbnNmb3JtID0gW1xuICAgICAgICAgICAgW2MycFRbMF0sICAgYzJwVFsxXSwgICAgMC4gXSxcbiAgICAgICAgICAgIFtjMnBUWzJdLCAgIGMycFRbM10sICAgIDAuIF0sXG4gICAgICAgICAgICBbYzJwVFs0XSwgICBjMnBUWzVdLCAgICAxLiBdXG4gICAgICAgIF07XG4gICAgICAgIHRoaXMuaW50ZXJwb2xhdGlvblNoYWRlci51cGRhdGVVbmlmb3JtRGF0YSh0aGlzLmdsLCAndV93b3JsZDJwaXgnLCBmbGF0dGVuUmVjdXJzaXZlKHdvcmxkVG9QaXhlbFRyYW5zZm9ybSkpO1xuXG4gICAgICAgIC8vIHVwZGF0ZSBwaXgyY2FudmFzXG4gICAgICAgIGNvbnN0IHBpeDJjYW52ID0gW1xuICAgICAgICAgICAgWzEuIC8gICh0aGlzLmNhbnZhcy53aWR0aCAvIDIpLCAgMC4sICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMC4gXSxcbiAgICAgICAgICAgIFswLCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0xLiAvICh0aGlzLmNhbnZhcy5oZWlnaHQgLyAyKSwgIDAuIF0sXG4gICAgICAgICAgICBbLTEuLCAgICAgICAgICAgICAgICAgICAgICAgICAgICAxLiwgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAxLiBdXG4gICAgICAgIF07XG4gICAgICAgIHRoaXMuaW50ZXJwb2xhdGlvblNoYWRlci51cGRhdGVVbmlmb3JtRGF0YSh0aGlzLmdsLCAndV9waXgyY2FudicsIGZsYXR0ZW5SZWN1cnNpdmUocGl4MmNhbnYpKTtcblxuICAgICAgICAvLyBiaW5kIG5ldyBkYXRhIGFuZCByZW5kZXJcbiAgICAgICAgdGhpcy5pbnRlcnBvbGF0aW9uU2hhZGVyLmJpbmQodGhpcy5nbCk7XG4gICAgICAgIHRoaXMuaW50ZXJwb2xhdGlvblNoYWRlci5yZW5kZXIodGhpcy5nbCwgWzAsIDAsIDAsIDBdLCB0aGlzLmludGVycG9sRmIuZmJvKTtcblxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cblxuICAgIHJlbmRlckZyYW1lKGZyYW1lU3RhdGU6IEZyYW1lU3RhdGUsIHRhcmdldDogSFRNTEVsZW1lbnQpOiBIVE1MRWxlbWVudCB7XG4gICAgICAgIHJldHVybiB0aGlzLmNhbnZhcztcbiAgICB9XG5cblxuICAgIHJlbmRlckRlY2x1dHRlcihmcmFtZVN0YXRlOiBGcmFtZVN0YXRlKSB7XG4gICAgfVxuXG5cbiAgICBwcml2YXRlIHBvaW50c1RvT2JzZXJ2YXRpb25zKGZlYXR1cmVzOiBGZWF0dXJlPFBvaW50PltdKTogbnVtYmVyW11bXSB7XG5cbiAgICAgICAgY29uc3QgcG9pbnRUb09ic2VydmF0aW9uID0gKGZlYXR1cmU6IEZlYXR1cmU8UG9pbnQ+KTogbnVtYmVyW10gPT4ge1xuICAgICAgICAgICAgY29uc3QgY29vcmRzID0gZmVhdHVyZS5nZXRHZW9tZXRyeSgpLmdldENvb3JkaW5hdGVzKCk7XG4gICAgICAgICAgICBjb25zdCBwcm9wcyA9IGZlYXR1cmUuZ2V0UHJvcGVydGllcygpO1xuICAgICAgICAgICAgcmV0dXJuIFtjb29yZHNbMF0sIGNvb3Jkc1sxXSwgcHJvcHMud2luZFswXSwgcHJvcHMud2luZFsxXV07XG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3QgY29vcmRpbmF0ZXMgPSBmZWF0dXJlcy5tYXAoZiA9PiBmLmdldEdlb21ldHJ5KCkuZ2V0Q29vcmRpbmF0ZXMoKSk7XG4gICAgICAgIGNvbnN0IGRlbGF1bmV5ID0gRGVsYXVuYXRvci5mcm9tKGNvb3JkaW5hdGVzKTtcbiAgICAgICAgY29uc3QgaW5kaWNlcyA9IGRlbGF1bmV5LnRyaWFuZ2xlcztcbiAgICAgICAgY29uc3QgYU9ic2VydmF0aW9ucyA9IFtdO1xuICAgICAgICBmb3IgKGNvbnN0IGkgb2YgaW5kaWNlcykge1xuICAgICAgICAgICAgY29uc3QgbyA9IHBvaW50VG9PYnNlcnZhdGlvbihmZWF0dXJlc1tpXSk7XG4gICAgICAgICAgICBhT2JzZXJ2YXRpb25zLnB1c2gobyk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gYU9ic2VydmF0aW9ucztcbiAgICB9XG59XG4iXX0=