import { Component, Input, HostBinding } from '@angular/core';
import { moveItemInArray } from '@angular/cdk/drag-drop';
import * as i0 from "@angular/core";
import * as i1 from "@dlr-eoc/core-ui";
import * as i2 from "../layerentry/layerentry.component";
import * as i3 from "@clr/angular";
import * as i4 from "@angular/common";
import * as i5 from "@angular/cdk/drag-drop";
import * as i6 from "../utils/array-reverse.pipe";
import * as i7 from "../utils/obj-type.pipe";
export class LayerentryGroupComponent {
    constructor() {
        // public visible: boolean = true;
        this.canZoomToGroup = false;
        this.showInfo = false;
        this.showAction = true;
    }
    get visible() { return this.group.visible; }
    get cssClass() { return this.group.cssClass; }
    set openAllLayersProperties(value) {
        if (this.group && this.group.layers.length) {
            this.group.layers.forEach(l => l.expanded = value);
        }
    }
    get openAllLayersProperties() {
        if (this.group && this.group.layers.length) {
            return this.group.layers.filter(l => l.expanded === true).length === this.group.layers.length;
        }
        else {
            return false;
        }
    }
    ngOnInit() {
        if (this.group.bbox && this.group.bbox.length >= 4) {
            this.canZoomToGroup = true;
        }
        if (!this.group?.action) {
            this.showAction = false;
        }
    }
    /**
     * obj: {any| IDynamicComponent}
     */
    checkIsComponentItem(group, compProp) {
        const obj = group[compProp];
        let isComp = false;
        if (obj && typeof obj === 'object') {
            if ('component' in obj) {
                if (!obj.inputs) {
                    // https://2ality.com/2014/01/object-assign.html#2.3
                    const groupClone = Object.assign({ __proto__: this.group['__proto__'] }, group);
                    if (groupClone && groupClone[compProp]) {
                        delete groupClone[compProp];
                    }
                    obj.inputs = { group: groupClone };
                }
                else if (obj.inputs && !obj.inputs.group) {
                    // https://2ality.com/2014/01/object-assign.html#2.3
                    const groupClone = Object.assign({ __proto__: this.group['__proto__'] }, group);
                    if (groupClone && groupClone[compProp]) {
                        delete groupClone[compProp];
                    }
                    obj.inputs = Object.assign({ group: groupClone }, obj.inputs);
                }
                isComp = true;
            }
        }
        return isComp;
    }
    checkBaselayer(group) {
        if (group && group.filtertype === 'Baselayers') {
            return true;
        }
        else {
            return false;
        }
    }
    checkClassHide(layer) {
        const hasHide = layer?.cssClass?.includes('hide') || false;
        return !hasHide;
    }
    getLayerName(group) {
        if (group.displayName) {
            return group.displayName;
        }
        else {
            return group.name;
        }
    }
    setLayerGroupIndex(group, dir) {
        this.layersSvc.setGroupLayerIndex(group, dir);
    }
    setGroupLayersVisibility() {
        this.group.visible = !this.group.visible;
        this.layersSvc.updateLayerGroup(this.group);
    }
    removeLayerGroup(group) {
        this.layersSvc.removeLayerGroup(group);
    }
    zoomTo(group) {
        if (this.mapState && group.bbox && group.bbox.length >= 4) {
            this.mapState.setExtent(group.bbox);
        }
    }
    layerUpdate(event, group) {
        const layer = event.layer;
        /** update event layer in the group... this is done by object reference!! */
        /* const updateLayerIndex = group.layers.findIndex(l => l.id === layer.id);
        if (updateLayerIndex !== -1) {
          group.layers[updateLayerIndex] = layer;
        } */
        this.layersSvc.updateLayerGroup(group);
    }
    showProperties() {
        this.group.expanded = !this.group.expanded;
    }
    showHideAllDetails() {
        this.openAllLayersProperties = !this.openAllLayersProperties;
        this.showAction = this.openAllLayersProperties;
        this.showInfo = this.openAllLayersProperties;
    }
    isFirst(group) {
        return this.layersSvc.isGroupFirst(group, this.layerGroups, group.filtertype);
    }
    isLast(group) {
        return this.layersSvc.isGroupLast(group, this.layerGroups, group.filtertype);
    }
    // CDKDRagAndDrop -------------------------------------------------------------
    // https://material.angular.io/cdk/drag-drop/api
    drop(event) {
        const groupLayers = this.group.layers;
        const groupLeng = groupLayers.length;
        const fiteredLayers = event.container.data; // filtered by [cdkDropListData]
        const groupFiteredLeng = fiteredLayers.length;
        let previousIFinal, newIFinal;
        /**
         * calc index with pipe reverse order
         */
        if (groupLeng === groupFiteredLeng) {
            const previousIndex = groupLeng - event.previousIndex - 1;
            const newIndex = groupLeng - event.currentIndex - 1;
            previousIFinal = previousIndex;
            newIFinal = newIndex;
        }
        else {
            /**
             * If array is filtered get previousIndex by item.data and try to calculate ne index
             * get layers for cdk indexes - 'connect' 'event.container.data' and the original not filtered data
             */
            const newLayer = fiteredLayers[event.currentIndex];
            const previousIndex = groupLayers.findIndex(l => l.id === event.item.data.id);
            let newIndex = groupLayers.findIndex(l => l.id === newLayer.id);
            // Item is not moved
            if (event.previousIndex === event.currentIndex) {
                newIndex = previousIndex;
            }
            previousIFinal = previousIndex;
            newIFinal = newIndex;
        }
        moveItemInArray(this.group.layers, previousIFinal, newIFinal);
        this.layersSvc.updateLayerGroup(this.group);
    }
}
LayerentryGroupComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.3.6", ngImport: i0, type: LayerentryGroupComponent, deps: [], target: i0.ɵɵFactoryTarget.Component });
LayerentryGroupComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "13.3.6", type: LayerentryGroupComponent, selector: "ukis-layerentry-group", inputs: { layersSvc: "layersSvc", mapState: "mapState", group: "group", layerGroups: "layerGroups" }, host: { properties: { "class.group-visible": "this.visible", "class": "this.cssClass" } }, ngImport: i0, template: "<div class=\"layergroup\">\n  <div class=\"head\">\n    <!-- layer expand icon -->\n    <clr-icon [attr.shape]=\"group.expanded?'folder-open':'folder'\" class=\"iconButton\" (click)=\"showProperties()\"\n      title=\"{{group.expanded?'Close':'Open'}}\"></clr-icon>\n\n\n    <!-- layer title -->\n    <div #ref class=\"item-title-replacement title\" (click)=\"showProperties()\" [title]=\"getLayerName(group)\">\n      <ng-content></ng-content>\n    </div>\n    <span *ngIf=\"ref.children.length == 0\" class=\"title\" [title]=\"getLayerName(group)\" (click)=\"showProperties()\">\n      {{getLayerName(group)}}\n    </span>\n\n    <!-- setLayerGroupIndex // for reversed layergroups on ngFor up is down -->\n    <span *ngIf=\"layerGroups.length>1\">\n      <clr-icon class=\"iconButton move-item\" [ngClass]=\"{'disabled':isLast(group)}\" shape=\"arrow\"\n        (click)=\"setLayerGroupIndex(group, 'down')\" title=\"up\"></clr-icon>\n      <clr-icon class=\"iconButton move-item\" [ngClass]=\"{'disabled':isFirst(group)}\" shape=\"arrow\"\n        (click)=\"setLayerGroupIndex(group, 'up')\" title=\"down\" dir=\"down\"></clr-icon>\n    </span>\n\n    <!-- setGroupLayersVisibility -->\n    <span *ngIf=\"!checkBaselayer(group)\">\n      <input class=\"hide\" [type]=\"'checkbox'\" [checked]=\"group.visible\" [name]=\"'group'\" [id]=\"group.id\"\n        (change)=\"setGroupLayersVisibility()\">\n      <label [for]=\"group.id\">\n        <clr-icon class=\"iconButton\" [ngClass]=\"{'is-solid':group.visible}\"\n          [attr.shape]=\"group.visible?'eye':'eye-hide'\" title=\"{{group.visible?'Hide Group':'Show Group'}}\"></clr-icon>\n      </label>\n    </span>\n  </div>\n\n  <div *ngIf=\"group.expanded\" class=\"body\">\n    <!-- tools: zoomTo, remove, open all Tabs -->\n    <div class=\"tools\">\n      <clr-icon *ngFor=\"let item of group.actions\" [attr.shape]=\"item.icon\" class=\"iconButton\"\n        (click)=\"item.action(group)\" [title]=\"item.title\">\n      </clr-icon>\n\n      <clr-icon *ngIf=\"group.action\" shape=\"cog\" class=\"iconButton\" [ngClass]=\"{'is-solid':showAction}\"\n        (click)=\"showAction = !showAction\" title=\"{{!showAction?'Show settings': 'Hide settings'}}\"></clr-icon>\n\n      <clr-icon *ngIf=\"group.description\" shape=\"info-standard\" class=\"iconButton\" [ngClass]=\"{'is-solid':showInfo}\"\n        (click)=\"showInfo = !showInfo\" title=\"{{!showInfo?'Show Info': 'Hide Info'}}\"></clr-icon>\n      <clr-icon shape=\"details\" class=\"iconButton\" [ngClass]=\"{'is-solid':openAllLayersProperties}\"\n        (click)=\"showHideAllDetails()\"\n        title=\"{{!openAllLayersProperties?'Show all layers details': 'Hide all layers details'}}\"></clr-icon>\n\n      <span></span>\n      <clr-icon *ngIf=\"canZoomToGroup\" shape=\"zoom-in\" class=\"iconButton\" (click)=\"zoomTo(group)\" title=\"Zoom to group\">\n      </clr-icon>\n      <clr-icon *ngIf=\"group.removable\" shape=\"trash\" class=\"iconButton\" (click)=\"removeLayerGroup(group)\"\n        title=\"Remove group\"></clr-icon>\n    </div>\n\n    <div class=\"info\" *ngIf=\"showInfo\">\n      <span [innerHTML]=\"group.description\"></span>\n    </div>\n    <div *ngIf=\"group.action && showAction\" class=\"tabsbody\">\n      <ng-container *ngIf=\"checkIsComponentItem(group, 'action');\">\n        <ukis-dynamic-component [(dynamicComponent)]=\"group.action\">\n        </ukis-dynamic-component>\n      </ng-container>\n    </div>\n\n\n    <!-- (cdkDropListSorted)=\"sort($event)\"  -->\n    <div cdkDropList (cdkDropListDropped)=\"drop($event)\"\n      [cdkDropListData]=\"group.layers | itemsfilter: checkClassHide | reverse\">\n      <ng-container *ngFor=\"let layer of group.layers | itemsfilter: checkClassHide | reverse\">\n        <div class=\"sublayers\" cdkDragLockAxis=\"y\" cdkDrag [cdkDragData]=\"{id:layer.id}\">\n          <ukis-layerentry [expanded]=\"openAllLayersProperties\" [layersSvc]=\"layersSvc\" [mapState]=\"mapState\"\n            [layer]=\"layer\" [group]=\"group\" (update)=\"layerUpdate($event, group)\">\n            <span class=\"move-item\" cdkDragHandle>\n              {{layer.displayName || layer.name}}\n            </span>\n          </ukis-layerentry>\n        </div>\n      </ng-container>\n    </div>\n  </div>\n</div>\n", styles: [".title{cursor:pointer}.item-title-replacement:empty{display:none}.cdk-drag-preview{display:flex;align-items:center;padding:0 10px;box-sizing:border-box;border-radius:2px;box-shadow:0 5px 5px -3px #0003,0 8px 10px 1px #00000024,0 3px 14px 2px #0000001f;overflow:hidden}.cdk-drag-placeholder{opacity:.2}.cdk-drag-animating{transition:transform .25s cubic-bezier(0,0,.2,1)}.example-box:last-child{border:none}.cdk-drop-list-dragging .sublayers:not(.cdk-drag-placeholder){transition:transform .25s cubic-bezier(0,0,.2,1)}.info{padding-left:.2rem}\n"], components: [{ type: i1.DynamicComponentComponent, selector: "ukis-dynamic-component", inputs: ["dynamicComponent"], outputs: ["dynamicComponentChange"] }, { type: i2.LayerentryComponent, selector: "ukis-layerentry", inputs: ["layersSvc", "mapState", "layer", "group", "layerGroups", "expanded", "expandable"], outputs: ["update"] }], directives: [{ type: i3.ClrIconCustomTag, selector: "clr-icon" }, { type: i4.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { type: i4.NgClass, selector: "[ngClass]", inputs: ["class", "ngClass"] }, { type: i3.ClrLabel, selector: "label", inputs: ["for"] }, { type: i4.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { type: i5.CdkDropList, selector: "[cdkDropList], cdk-drop-list", inputs: ["cdkDropListConnectedTo", "cdkDropListData", "cdkDropListOrientation", "id", "cdkDropListLockAxis", "cdkDropListDisabled", "cdkDropListSortingDisabled", "cdkDropListEnterPredicate", "cdkDropListSortPredicate", "cdkDropListAutoScrollDisabled", "cdkDropListAutoScrollStep"], outputs: ["cdkDropListDropped", "cdkDropListEntered", "cdkDropListExited", "cdkDropListSorted"], exportAs: ["cdkDropList"] }, { type: i5.CdkDrag, selector: "[cdkDrag]", inputs: ["cdkDragData", "cdkDragLockAxis", "cdkDragRootElement", "cdkDragBoundary", "cdkDragStartDelay", "cdkDragFreeDragPosition", "cdkDragDisabled", "cdkDragConstrainPosition", "cdkDragPreviewClass", "cdkDragPreviewContainer"], outputs: ["cdkDragStarted", "cdkDragReleased", "cdkDragEnded", "cdkDragEntered", "cdkDragExited", "cdkDragDropped", "cdkDragMoved"], exportAs: ["cdkDrag"] }, { type: i5.CdkDragHandle, selector: "[cdkDragHandle]", inputs: ["cdkDragHandleDisabled"] }], pipes: { "reverse": i6.ReversePipe, "itemsfilter": i7.ItemsFilterPipe } });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.3.6", ngImport: i0, type: LayerentryGroupComponent, decorators: [{
            type: Component,
            args: [{ selector: 'ukis-layerentry-group', template: "<div class=\"layergroup\">\n  <div class=\"head\">\n    <!-- layer expand icon -->\n    <clr-icon [attr.shape]=\"group.expanded?'folder-open':'folder'\" class=\"iconButton\" (click)=\"showProperties()\"\n      title=\"{{group.expanded?'Close':'Open'}}\"></clr-icon>\n\n\n    <!-- layer title -->\n    <div #ref class=\"item-title-replacement title\" (click)=\"showProperties()\" [title]=\"getLayerName(group)\">\n      <ng-content></ng-content>\n    </div>\n    <span *ngIf=\"ref.children.length == 0\" class=\"title\" [title]=\"getLayerName(group)\" (click)=\"showProperties()\">\n      {{getLayerName(group)}}\n    </span>\n\n    <!-- setLayerGroupIndex // for reversed layergroups on ngFor up is down -->\n    <span *ngIf=\"layerGroups.length>1\">\n      <clr-icon class=\"iconButton move-item\" [ngClass]=\"{'disabled':isLast(group)}\" shape=\"arrow\"\n        (click)=\"setLayerGroupIndex(group, 'down')\" title=\"up\"></clr-icon>\n      <clr-icon class=\"iconButton move-item\" [ngClass]=\"{'disabled':isFirst(group)}\" shape=\"arrow\"\n        (click)=\"setLayerGroupIndex(group, 'up')\" title=\"down\" dir=\"down\"></clr-icon>\n    </span>\n\n    <!-- setGroupLayersVisibility -->\n    <span *ngIf=\"!checkBaselayer(group)\">\n      <input class=\"hide\" [type]=\"'checkbox'\" [checked]=\"group.visible\" [name]=\"'group'\" [id]=\"group.id\"\n        (change)=\"setGroupLayersVisibility()\">\n      <label [for]=\"group.id\">\n        <clr-icon class=\"iconButton\" [ngClass]=\"{'is-solid':group.visible}\"\n          [attr.shape]=\"group.visible?'eye':'eye-hide'\" title=\"{{group.visible?'Hide Group':'Show Group'}}\"></clr-icon>\n      </label>\n    </span>\n  </div>\n\n  <div *ngIf=\"group.expanded\" class=\"body\">\n    <!-- tools: zoomTo, remove, open all Tabs -->\n    <div class=\"tools\">\n      <clr-icon *ngFor=\"let item of group.actions\" [attr.shape]=\"item.icon\" class=\"iconButton\"\n        (click)=\"item.action(group)\" [title]=\"item.title\">\n      </clr-icon>\n\n      <clr-icon *ngIf=\"group.action\" shape=\"cog\" class=\"iconButton\" [ngClass]=\"{'is-solid':showAction}\"\n        (click)=\"showAction = !showAction\" title=\"{{!showAction?'Show settings': 'Hide settings'}}\"></clr-icon>\n\n      <clr-icon *ngIf=\"group.description\" shape=\"info-standard\" class=\"iconButton\" [ngClass]=\"{'is-solid':showInfo}\"\n        (click)=\"showInfo = !showInfo\" title=\"{{!showInfo?'Show Info': 'Hide Info'}}\"></clr-icon>\n      <clr-icon shape=\"details\" class=\"iconButton\" [ngClass]=\"{'is-solid':openAllLayersProperties}\"\n        (click)=\"showHideAllDetails()\"\n        title=\"{{!openAllLayersProperties?'Show all layers details': 'Hide all layers details'}}\"></clr-icon>\n\n      <span></span>\n      <clr-icon *ngIf=\"canZoomToGroup\" shape=\"zoom-in\" class=\"iconButton\" (click)=\"zoomTo(group)\" title=\"Zoom to group\">\n      </clr-icon>\n      <clr-icon *ngIf=\"group.removable\" shape=\"trash\" class=\"iconButton\" (click)=\"removeLayerGroup(group)\"\n        title=\"Remove group\"></clr-icon>\n    </div>\n\n    <div class=\"info\" *ngIf=\"showInfo\">\n      <span [innerHTML]=\"group.description\"></span>\n    </div>\n    <div *ngIf=\"group.action && showAction\" class=\"tabsbody\">\n      <ng-container *ngIf=\"checkIsComponentItem(group, 'action');\">\n        <ukis-dynamic-component [(dynamicComponent)]=\"group.action\">\n        </ukis-dynamic-component>\n      </ng-container>\n    </div>\n\n\n    <!-- (cdkDropListSorted)=\"sort($event)\"  -->\n    <div cdkDropList (cdkDropListDropped)=\"drop($event)\"\n      [cdkDropListData]=\"group.layers | itemsfilter: checkClassHide | reverse\">\n      <ng-container *ngFor=\"let layer of group.layers | itemsfilter: checkClassHide | reverse\">\n        <div class=\"sublayers\" cdkDragLockAxis=\"y\" cdkDrag [cdkDragData]=\"{id:layer.id}\">\n          <ukis-layerentry [expanded]=\"openAllLayersProperties\" [layersSvc]=\"layersSvc\" [mapState]=\"mapState\"\n            [layer]=\"layer\" [group]=\"group\" (update)=\"layerUpdate($event, group)\">\n            <span class=\"move-item\" cdkDragHandle>\n              {{layer.displayName || layer.name}}\n            </span>\n          </ukis-layerentry>\n        </div>\n      </ng-container>\n    </div>\n  </div>\n</div>\n", styles: [".title{cursor:pointer}.item-title-replacement:empty{display:none}.cdk-drag-preview{display:flex;align-items:center;padding:0 10px;box-sizing:border-box;border-radius:2px;box-shadow:0 5px 5px -3px #0003,0 8px 10px 1px #00000024,0 3px 14px 2px #0000001f;overflow:hidden}.cdk-drag-placeholder{opacity:.2}.cdk-drag-animating{transition:transform .25s cubic-bezier(0,0,.2,1)}.example-box:last-child{border:none}.cdk-drop-list-dragging .sublayers:not(.cdk-drag-placeholder){transition:transform .25s cubic-bezier(0,0,.2,1)}.info{padding-left:.2rem}\n"] }]
        }], ctorParameters: function () { return []; }, propDecorators: { visible: [{
                type: HostBinding,
                args: ['class.group-visible']
            }], cssClass: [{
                type: HostBinding,
                args: ['class']
            }], layersSvc: [{
                type: Input,
                args: ['layersSvc']
            }], mapState: [{
                type: Input,
                args: ['mapState']
            }], group: [{
                type: Input,
                args: ['group']
            }], layerGroups: [{
                type: Input,
                args: ['layerGroups']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGF5ZXJlbnRyeS1ncm91cC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9sYXllci1jb250cm9sL3NyYy9saWIvbGF5ZXJlbnRyeS1ncm91cC9sYXllcmVudHJ5LWdyb3VwLmNvbXBvbmVudC50cyIsIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2xheWVyLWNvbnRyb2wvc3JjL2xpYi9sYXllcmVudHJ5LWdyb3VwL2xheWVyZW50cnktZ3JvdXAuY29tcG9uZW50Lmh0bWwiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBVSxLQUFLLEVBQUUsV0FBVyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBT3RFLE9BQU8sRUFBZSxlQUFlLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQzs7Ozs7Ozs7O0FBT3RFLE1BQU0sT0FBTyx3QkFBd0I7SUEyQm5DO1FBTkEsa0NBQWtDO1FBQzNCLG1CQUFjLEdBQUcsS0FBSyxDQUFDO1FBRXZCLGFBQVEsR0FBRyxLQUFLLENBQUM7UUFDakIsZUFBVSxHQUFHLElBQUksQ0FBQztJQUVULENBQUM7SUExQmpCLElBQXdDLE9BQU8sS0FBSyxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztJQUNoRixJQUEwQixRQUFRLEtBQUssT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7SUFPcEUsSUFBVyx1QkFBdUIsQ0FBQyxLQUFjO1FBQy9DLElBQUksSUFBSSxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUU7WUFDMUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUMsQ0FBQztTQUNwRDtJQUNILENBQUM7SUFDRCxJQUFXLHVC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QkFBQyxhQUFhIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQsIElucHV0LCBIb3N0QmluZGluZyB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5cbi8vIGltcG9ydHMgb25seSBmb3IgdHlwaW5ncy4uLlxuaW1wb3J0IHsgTGF5ZXJHcm91cCwgTGF5ZXIgfSBmcm9tICdAZGxyLWVvYy9zZXJ2aWNlcy1sYXllcnMnO1xuaW1wb3J0IHsgTWFwU3RhdGVTZXJ2aWNlIH0gZnJvbSAnQGRsci1lb2Mvc2VydmljZXMtbWFwLXN0YXRlJztcbmltcG9ydCB7IExheWVyc1NlcnZpY2UgfSBmcm9tICdAZGxyLWVvYy9zZXJ2aWNlcy1sYXllcnMnO1xuaW1wb3J0IHsgQ2RrRHJhZ0Ryb3AsIG1vdmVJdGVtSW5BcnJheSB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9kcmFnLWRyb3AnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICd1a2lzLWxheWVyZW50cnktZ3JvdXAnLFxuICB0ZW1wbGF0ZVVybDogJy4vbGF5ZXJlbnRyeS1ncm91cC5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL2xheWVyZW50cnktZ3JvdXAuY29tcG9uZW50LnNjc3MnXVxufSlcbmV4cG9ydCBjbGFzcyBMYXllcmVudHJ5R3JvdXBDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xuICBASG9zdEJpbmRpbmcoJ2NsYXNzLmdyb3VwLXZpc2libGUnKSBnZXQgdmlzaWJsZSgpIHsgcmV0dXJuIHRoaXMuZ3JvdXAudmlzaWJsZTsgfVxuICBASG9zdEJpbmRpbmcoJ2NsYXNzJykgZ2V0IGNzc0NsYXNzKCkgeyByZXR1cm4gdGhpcy5ncm91cC5jc3NDbGFzczsgfVxuXG4gIEBJbnB1dCgnbGF5ZXJzU3ZjJykgbGF5ZXJzU3ZjOiBMYXllcnNTZXJ2aWNlO1xuICBASW5wdXQoJ21hcFN0YXRlJykgbWFwU3RhdGU/OiBNYXBTdGF0ZVNlcnZpY2U7XG4gIEBJbnB1dCgnZ3JvdXAnKSBncm91cDogTGF5ZXJHcm91cDtcbiAgQElucHV0KCdsYXllckdyb3VwcycpIGxheWVyR3JvdXBzOiBBcnJheTxMYXllciB8IExheWVyR3JvdXA+O1xuXG4gIHB1YmxpYyBzZXQgb3BlbkFsbExheWVyc1Byb3BlcnRpZXModmFsdWU6IGJvb2xlYW4pIHtcbiAgICBpZiAodGhpcy5ncm91cCAmJiB0aGlzLmdyb3VwLmxheWVycy5sZW5ndGgpIHtcbiAgICAgIHRoaXMuZ3JvdXAubGF5ZXJzLmZvckVhY2gobCA9PiBsLmV4cGFuZGVkID0gdmFsdWUpO1xuICAgIH1cbiAgfVxuICBwdWJsaWMgZ2V0IG9wZW5BbGxMYXllcnNQcm9wZXJ0aWVzKCkge1xuICAgIGlmICh0aGlzLmdyb3VwICYmIHRoaXMuZ3JvdXAubGF5ZXJzLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIHRoaXMuZ3JvdXAubGF5ZXJzLmZpbHRlcihsID0+IGwuZXhwYW5kZWQgPT09IHRydWUpLmxlbmd0aCA9PT0gdGhpcy5ncm91cC5sYXllcnMubGVuZ3RoO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG4gIC8vIHB1YmxpYyB2aXNpYmxlOiBib29sZWFuID0gdHJ1ZTtcbiAgcHVibGljIGNhblpvb21Ub0dyb3VwID0gZmFsc2U7XG5cbiAgcHVibGljIHNob3dJbmZvID0gZmFsc2U7XG4gIHB1YmxpYyBzaG93QWN0aW9uID0gdHJ1ZTtcblxuICBjb25zdHJ1Y3RvcigpIHsgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIGlmICh0aGlzLmdyb3VwLmJib3ggJiYgdGhpcy5ncm91cC5iYm94Lmxlbmd0aCA+PSA0KSB7XG4gICAgICB0aGlzLmNhblpvb21Ub0dyb3VwID0gdHJ1ZTtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuZ3JvdXA/LmFjdGlvbikge1xuICAgICAgdGhpcy5zaG93QWN0aW9uID0gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIG9iajoge2FueXwgSUR5bmFtaWNDb21wb25lbnR9XG4gICAqL1xuICBjaGVja0lzQ29tcG9uZW50SXRlbShncm91cDogTGF5ZXJHcm91cCwgY29tcFByb3A6IHN0cmluZykge1xuICAgIGNvbnN0IG9iaiA9IGdyb3VwW2NvbXBQcm9wXTtcbiAgICBsZXQgaXNDb21wID0gZmFsc2U7XG4gICAgaWYgKG9iaiAmJiB0eXBlb2Ygb2JqID09PSAnb2JqZWN0Jykge1xuICAgICAgaWYgKCdjb21wb25lbnQnIGluIG9iaikge1xuICAgICAgICBpZiAoIW9iai5pbnB1dHMpIHtcbiAgICAgICAgICAvLyBodHRwczovLzJhbGl0eS5jb20vMjAxNC8wMS9vYmplY3QtYXNzaWduLmh0bWwjMi4zXG4gICAgICAgICAgY29uc3QgZ3JvdXBDbG9uZSA9IE9iamVjdC5hc3NpZ24oeyBfX3Byb3RvX186IHRoaXMuZ3JvdXBbJ19fcHJvdG9fXyddIH0sIGdyb3VwKTtcbiAgICAgICAgICBpZiAoZ3JvdXBDbG9uZSAmJiBncm91cENsb25lW2NvbXBQcm9wXSkge1xuICAgICAgICAgICAgZGVsZXRlIGdyb3VwQ2xvbmVbY29tcFByb3BdO1xuICAgICAgICAgIH1cbiAgICAgICAgICBvYmouaW5wdXRzID0geyBncm91cDogZ3JvdXBDbG9uZSB9O1xuICAgICAgICB9IGVsc2UgaWYgKG9iai5pbnB1dHMgJiYgIW9iai5pbnB1dHMuZ3JvdXApIHtcbiAgICAgICAgICAvLyBodHRwczovLzJhbGl0eS5jb20vMjAxNC8wMS9vYmplY3QtYXNzaWduLmh0bWwjMi4zXG4gICAgICAgICAgY29uc3QgZ3JvdXBDbG9uZSA9IE9iamVjdC5hc3NpZ24oeyBfX3Byb3RvX186IHRoaXMuZ3JvdXBbJ19fcHJvdG9fXyddIH0sIGdyb3VwKTtcbiAgICAgICAgICBpZiAoZ3JvdXBDbG9uZSAmJiBncm91cENsb25lW2NvbXBQcm9wXSkge1xuICAgICAgICAgICAgZGVsZXRlIGdyb3VwQ2xvbmVbY29tcFByb3BdO1xuICAgICAgICAgIH1cbiAgICAgICAgICBvYmouaW5wdXRzID0gT2JqZWN0LmFzc2lnbih7IGdyb3VwOiBncm91cENsb25lIH0sIG9iai5pbnB1dHMpO1xuICAgICAgICB9XG4gICAgICAgIGlzQ29tcCA9IHRydWU7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBpc0NvbXA7XG4gIH1cblxuICBjaGVja0Jhc2VsYXllcihncm91cDogTGF5ZXJHcm91cCkge1xuICAgIGlmIChncm91cCAmJiBncm91cC5maWx0ZXJ0eXBlID09PSAnQmFzZWxheWVycycpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgY2hlY2tDbGFzc0hpZGUobGF5ZXI6IExheWVyKSB7XG4gICAgY29uc3QgaGFzSGlkZSA9IGxheWVyPy5jc3NDbGFzcz8uaW5jbHVkZXMoJ2hpZGUnKSB8fCBmYWxzZTtcbiAgICByZXR1cm4gIWhhc0hpZGU7XG4gIH1cblxuICBnZXRMYXllck5hbWUoZ3JvdXA6IExheWVyR3JvdXApIHtcbiAgICBpZiAoZ3JvdXAuZGlzcGxheU5hbWUpIHtcbiAgICAgIHJldHVybiBncm91cC5kaXNwbGF5TmFtZTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGdyb3VwLm5hbWU7XG4gICAgfVxuICB9XG5cbiAgc2V0TGF5ZXJHcm91cEluZGV4KGdyb3VwOiBMYXllckdyb3VwLCBkaXIpIHtcbiAgICB0aGlzLmxheWVyc1N2Yy5zZXRHcm91cExheWVySW5kZXgoZ3JvdXAsIGRpcik7XG4gIH1cblxuICBzZXRHcm91cExheWVyc1Zpc2liaWxpdHkoKSB7XG4gICAgdGhpcy5ncm91cC52aXNpYmxlID0gIXRoaXMuZ3JvdXAudmlzaWJsZTtcbiAgICB0aGlzLmxheWVyc1N2Yy51cGRhdGVMYXllckdyb3VwKHRoaXMuZ3JvdXApO1xuICB9XG5cbiAgcmVtb3ZlTGF5ZXJHcm91cChncm91cDogTGF5ZXJHcm91cCkge1xuICAgIHRoaXMubGF5ZXJzU3ZjLnJlbW92ZUxheWVyR3JvdXAoZ3JvdXApO1xuICB9XG5cblxuICB6b29tVG8oZ3JvdXA6IExheWVyR3JvdXApIHtcbiAgICBpZiAodGhpcy5tYXBTdGF0ZSAmJiBncm91cC5iYm94ICYmIGdyb3VwLmJib3gubGVuZ3RoID49IDQpIHtcbiAgICAgIHRoaXMubWFwU3RhdGUuc2V0RXh0ZW50KGdyb3VwLmJib3gpO1xuICAgIH1cbiAgfVxuXG4gIGxheWVyVXBkYXRlKGV2ZW50LCBncm91cDogTGF5ZXJHcm91cCkge1xuICAgIGNvbnN0IGxheWVyID0gZXZlbnQubGF5ZXIgYXMgTGF5ZXI7XG4gICAgLyoqIHVwZGF0ZSBldmVudCBsYXllciBpbiB0aGUgZ3JvdXAuLi4gdGhpcyBpcyBkb25lIGJ5IG9iamVjdCByZWZlcmVuY2UhISAqL1xuICAgIC8qIGNvbnN0IHVwZGF0ZUxheWVySW5kZXggPSBncm91cC5sYXllcnMuZmluZEluZGV4KGwgPT4gbC5pZCA9PT0gbGF5ZXIuaWQpO1xuICAgIGlmICh1cGRhdGVMYXllckluZGV4ICE9PSAtMSkge1xuICAgICAgZ3JvdXAubGF5ZXJzW3VwZGF0ZUxheWVySW5kZXhdID0gbGF5ZXI7XG4gICAgfSAqL1xuICAgIHRoaXMubGF5ZXJzU3ZjLnVwZGF0ZUxheWVyR3JvdXAoZ3JvdXApO1xuICB9XG5cblxuICBzaG93UHJvcGVydGllcygpIHtcbiAgICB0aGlzLmdyb3VwLmV4cGFuZGVkID0gIXRoaXMuZ3JvdXAuZXhwYW5kZWQ7XG4gIH1cblxuICBzaG93SGlkZUFsbERldGFpbHMoKSB7XG4gICAgdGhpcy5vcGVuQWxsTGF5ZXJzUHJvcGVydGllcyA9ICF0aGlzLm9wZW5BbGxMYXllcnNQcm9wZXJ0aWVzO1xuICAgIHRoaXMuc2hvd0FjdGlvbiA9IHRoaXMub3BlbkFsbExheWVyc1Byb3BlcnRpZXM7XG4gICAgdGhpcy5zaG93SW5mbyA9IHRoaXMub3BlbkFsbExheWVyc1Byb3BlcnRpZXM7XG4gIH1cblxuICBpc0ZpcnN0KGdyb3VwKSB7XG4gICAgcmV0dXJuIHRoaXMubGF5ZXJzU3ZjLmlzR3JvdXBGaXJzdChncm91cCwgdGhpcy5sYXllckdyb3VwcywgZ3JvdXAuZmlsdGVydHlwZSk7XG4gIH1cblxuICBpc0xhc3QoZ3JvdXApIHtcbiAgICByZXR1cm4gdGhpcy5sYXllcnNTdmMuaXNHcm91cExhc3QoZ3JvdXAsIHRoaXMubGF5ZXJHcm91cHMsIGdyb3VwLmZpbHRlcnR5cGUpO1xuICB9XG5cblxuICAvLyBDREtEUmFnQW5kRHJvcCAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vIGh0dHBzOi8vbWF0ZXJpYWwuYW5ndWxhci5pby9jZGsvZHJhZy1kcm9wL2FwaVxuICBkcm9wKGV2ZW50OiBDZGtEcmFnRHJvcDxMYXllcltdPikge1xuICAgIGNvbnN0IGdyb3VwTGF5ZXJzID0gdGhpcy5ncm91cC5sYXllcnM7XG4gICAgY29uc3QgZ3JvdXBMZW5nID0gZ3JvdXBMYXllcnMubGVuZ3RoO1xuICAgIGNvbnN0IGZpdGVyZWRMYXllcnMgPSBldmVudC5jb250YWluZXIuZGF0YTsgLy8gZmlsdGVyZWQgYnkgW2Nka0Ryb3BMaXN0RGF0YV1cbiAgICBjb25zdCBncm91cEZpdGVyZWRMZW5nID0gZml0ZXJlZExheWVycy5sZW5ndGg7XG4gICAgbGV0IHByZXZpb3VzSUZpbmFsLCBuZXdJRmluYWw7XG5cbiAgICAvKipcbiAgICAgKiBjYWxjIGluZGV4IHdpdGggcGlwZSByZXZlcnNlIG9yZGVyXG4gICAgICovXG4gICAgaWYgKGdyb3VwTGVuZyA9PT0gZ3JvdXBGaXRlcmVkTGVuZykge1xuICAgICAgY29uc3QgcHJldmlvdXNJbmRleCA9IGdyb3VwTGVuZyAtIGV2ZW50LnByZXZpb3VzSW5kZXggLSAxO1xuICAgICAgY29uc3QgbmV3SW5kZXggPSBncm91cExlbmcgLSBldmVudC5jdXJyZW50SW5kZXggLSAxO1xuICAgICAgcHJldmlvdXNJRmluYWwgPSBwcmV2aW91c0luZGV4O1xuICAgICAgbmV3SUZpbmFsID0gbmV3SW5kZXg7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8qKlxuICAgICAgICogSWYgYXJyYXkgaXMgZmlsdGVyZWQgZ2V0IHByZXZpb3VzSW5kZXggYnkgaXRlbS5kYXRhIGFuZCB0cnkgdG8gY2FsY3VsYXRlIG5lIGluZGV4XG4gICAgICAgKiBnZXQgbGF5ZXJzIGZvciBjZGsgaW5kZXhlcyAtICdjb25uZWN0JyAnZXZlbnQuY29udGFpbmVyLmRhdGEnIGFuZCB0aGUgb3JpZ2luYWwgbm90IGZpbHRlcmVkIGRhdGFcbiAgICAgICAqL1xuICAgICAgY29uc3QgbmV3TGF5ZXIgPSBmaXRlcmVkTGF5ZXJzW2V2ZW50LmN1cnJlbnRJbmRleF07XG4gICAgICBjb25zdCBwcmV2aW91c0luZGV4ID0gZ3JvdXBMYXllcnMuZmluZEluZGV4KGwgPT4gbC5pZCA9PT0gZXZlbnQuaXRlbS5kYXRhLmlkKTtcbiAgICAgIGxldCBuZXdJbmRleCA9IGdyb3VwTGF5ZXJzLmZpbmRJbmRleChsID0+IGwuaWQgPT09IG5ld0xheWVyLmlkKTtcblxuICAgICAgLy8gSXRlbSBpcyBub3QgbW92ZWRcbiAgICAgIGlmIChldmVudC5wcmV2aW91c0luZGV4ID09PSBldmVudC5jdXJyZW50SW5kZXgpIHtcbiAgICAgICAgbmV3SW5kZXggPSBwcmV2aW91c0luZGV4O1xuICAgICAgfVxuXG4gICAgICBwcmV2aW91c0lGaW5hbCA9IHByZXZpb3VzSW5kZXg7XG4gICAgICBuZXdJRmluYWwgPSBuZXdJbmRleDtcbiAgICB9XG5cbiAgICBtb3ZlSXRlbUluQXJyYXkodGhpcy5ncm91cC5sYXllcnMsIHByZXZpb3VzSUZpbmFsLCBuZXdJRmluYWwpO1xuICAgIHRoaXMubGF5ZXJzU3ZjLnVwZGF0ZUxheWVyR3JvdXAodGhpcy5ncm91cCk7XG4gIH1cbn1cbiIsIjxkaXYgY2xhc3M9XCJsYXllcmdyb3VwXCI+XG4gIDxkaXYgY2xhc3M9XCJoZWFkXCI+XG4gICAgPCEtLSBsYXllciBleHBhbmQgaWNvbiAtLT5cbiAgICA8Y2xyLWljb24gW2F0dHIuc2hhcGVdPVwiZ3JvdXAuZXhwYW5kZWQ/J2ZvbGRlci1vcGVuJzonZm9sZGVyJ1wiIGNsYXNzPVwiaWNvbkJ1dHRvblwiIChjbGljayk9XCJzaG93UHJvcGVydGllcygpXCJcbiAgICAgIHRpdGxlPVwie3tncm91cC5leHBhbmRlZD8nQ2xvc2UnOidPcGVuJ319XCI+PC9jbHItaWNvbj5cblxuXG4gICAgPCEtLSBsYXllciB0aXRsZSAtLT5cbiAgICA8ZGl2ICNyZWYgY2xhc3M9XCJpdGVtLXRpdGxlLXJlcGxhY2VtZW50IHRpdGxlXCIgKGNsaWNrKT1cInNob3dQcm9wZXJ0aWVzKClcIiBbdGl0bGVdPVwiZ2V0TGF5ZXJOYW1lKGdyb3VwKVwiPlxuICAgICAgPG5nLWNvbnRlbnQ+PC9uZy1jb250ZW50PlxuICAgIDwvZGl2PlxuICAgIDxzcGFuICpuZ0lmPVwicmVmLmNoaWxkcmVuLmxlbmd0aCA9PSAwXCIgY2xhc3M9XCJ0aXRsZVwiIFt0aXRsZV09XCJnZXRMYXllck5hbWUoZ3JvdXApXCIgKGNsaWNrKT1cInNob3dQcm9wZXJ0aWVzKClcIj5cbiAgICAgIHt7Z2V0TGF5ZXJOYW1lKGdyb3VwKX19XG4gICAgPC9zcGFuPlxuXG4gICAgPCEtLSBzZXRMYXllckdyb3VwSW5kZXggLy8gZm9yIHJldmVyc2VkIGxheWVyZ3JvdXBzIG9uIG5nRm9yIHVwIGlzIGRvd24gLS0+XG4gICAgPHNwYW4gKm5nSWY9XCJsYXllckdyb3Vwcy5sZW5ndGg+MVwiPlxuICAgICAgPGNsci1pY29uIGNsYXNzPVwiaWNvbkJ1dHRvbiBtb3ZlLWl0ZW1cIiBbbmdDbGFzc109XCJ7J2Rpc2FibGVkJzppc0xhc3QoZ3JvdXApfVwiIHNoYXBlPVwiYXJyb3dcIlxuICAgICAgICAoY2xpY2spPVwic2V0TGF5ZXJHcm91cEluZGV4KGdyb3VwLCAnZG93bicpXCIgdGl0bGU9XCJ1cFwiPjwvY2xyLWljb24+XG4gICAgICA8Y2xyLWljb24gY2xhc3M9XCJpY29uQnV0dG9uIG1vdmUtaXRlbVwiIFtuZ0NsYXNzXT1cInsnZGlzYWJsZWQnOmlzRmlyc3QoZ3JvdXApfVwiIHNoYXBlPVwiYXJyb3dcIlxuICAgICAgICAoY2xpY2spPVwic2V0TGF5ZXJHcm91cEluZGV4KGdyb3VwLCAndXAnKVwiIHRpdGxlPVwiZG93blwiIGRpcj1cImRvd25cIj48L2Nsci1pY29uPlxuICAgIDwvc3Bhbj5cblxuICAgIDwhLS0gc2V0R3JvdXBMYXllcnNWaXNpYmlsaXR5IC0tPlxuICAgIDxzcGFuICpuZ0lmPVwiIWNoZWNrQmFzZWxheWVyKGdyb3VwKVwiPlxuICAgICAgPGlucHV0IGNsYXNzPVwiaGlkZVwiIFt0eXBlXT1cIidjaGVja2JveCdcIiBbY2hlY2tlZF09XCJncm91cC52aXNpYmxlXCIgW25hbWVdPVwiJ2dyb3VwJ1wiIFtpZF09XCJncm91cC5pZFwiXG4gICAgICAgIChjaGFuZ2UpPVwic2V0R3JvdXBMYXllcnNWaXNpYmlsaXR5KClcIj5cbiAgICAgIDxsYWJlbCBbZm9yXT1cImdyb3VwLmlkXCI+XG4gICAgICAgIDxjbHItaWNvbiBjbGFzcz1cImljb25CdXR0b25cIiBbbmdDbGFzc109XCJ7J2lzLXNvbGlkJzpncm91cC52aXNpYmxlfVwiXG4gICAgICAgICAgW2F0dHIuc2hhcGVdPVwiZ3JvdXAudmlzaWJsZT8nZXllJzonZXllLWhpZGUnXCIgdGl0bGU9XCJ7e2dyb3VwLnZpc2libGU/J0hpZGUgR3JvdXAnOidTaG93IEdyb3VwJ319XCI+PC9jbHItaWNvbj5cbiAgICAgIDwvbGFiZWw+XG4gICAgPC9zcGFuPlxuICA8L2Rpdj5cblxuICA8ZGl2ICpuZ0lmPVwiZ3JvdXAuZXhwYW5kZWRcIiBjbGFzcz1cImJvZHlcIj5cbiAgICA8IS0tIHRvb2xzOiB6b29tVG8sIHJlbW92ZSwgb3BlbiBhbGwgVGFicyAtLT5cbiAgICA8ZGl2IGNsYXNzPVwidG9vbHNcIj5cbiAgICAgIDxjbHItaWNvbiAqbmdGb3I9XCJsZXQgaXRlbSBvZiBncm91cC5hY3Rpb25zXCIgW2F0dHIuc2hhcGVdPVwiaXRlbS5pY29uXCIgY2xhc3M9XCJpY29uQnV0dG9uXCJcbiAgICAgICAgKGNsaWNrKT1cIml0ZW0uYWN0aW9uKGdyb3VwKVwiIFt0aXRsZV09XCJpdGVtLnRpdGxlXCI+XG4gICAgICA8L2Nsci1pY29uPlxuXG4gICAgICA8Y2xyLWljb24gKm5nSWY9XCJncm91cC5hY3Rpb25cIiBzaGFwZT1cImNvZ1wiIGNsYXNzPVwiaWNvbkJ1dHRvblwiIFtuZ0NsYXNzXT1cInsnaXMtc29saWQnOnNob3dBY3Rpb259XCJcbiAgICAgICAgKGNsaWNrKT1cInNob3dBY3Rpb24gPSAhc2hvd0FjdGlvblwiIHRpdGxlPVwie3shc2hvd0FjdGlvbj8nU2hvdyBzZXR0aW5ncyc6ICdIaWRlIHNldHRpbmdzJ319XCI+PC9jbHItaWNvbj5cblxuICAgICAgPGNsci1pY29uICpuZ0lmPVwiZ3JvdXAuZGVzY3JpcHRpb25cIiBzaGFwZT1cImluZm8tc3RhbmRhcmRcIiBjbGFzcz1cImljb25CdXR0b25cIiBbbmdDbGFzc109XCJ7J2lzLXNvbGlkJzpzaG93SW5mb31cIlxuICAgICAgICAoY2xpY2spPVwic2hvd0luZm8gPSAhc2hvd0luZm9cIiB0aXRsZT1cInt7IXNob3dJbmZvPydTaG93IEluZm8nOiAnSGlkZSBJbmZvJ319XCI+PC9jbHItaWNvbj5cbiAgICAgIDxjbHItaWNvbiBzaGFwZT1cImRldGFpbHNcIiBjbGFzcz1cImljb25CdXR0b25cIiBbbmdDbGFzc109XCJ7J2lzLXNvbGlkJzpvcGVuQWxsTGF5ZXJzUHJvcGVydGllc31cIlxuICAgICAgICAoY2xpY2spPVwic2hvd0hpZGVBbGxEZXRhaWxzKClcIlxuICAgICAgICB0aXRsZT1cInt7IW9wZW5BbGxMYXllcnNQcm9wZXJ0aWVzPydTaG93IGFsbCBsYXllcnMgZGV0YWlscyc6ICdIaWRlIGFsbCBsYXllcnMgZGV0YWlscyd9fVwiPjwvY2xyLWljb24+XG5cbiAgICAgIDxzcGFuPjwvc3Bhbj5cbiAgICAgIDxjbHItaWNvbiAqbmdJZj1cImNhblpvb21Ub0dyb3VwXCIgc2hhcGU9XCJ6b29tLWluXCIgY2xhc3M9XCJpY29uQnV0dG9uXCIgKGNsaWNrKT1cInpvb21Ubyhncm91cClcIiB0aXRsZT1cIlpvb20gdG8gZ3JvdXBcIj5cbiAgICAgIDwvY2xyLWljb24+XG4gICAgICA8Y2xyLWljb24gKm5nSWY9XCJncm91cC5yZW1vdmFibGVcIiBzaGFwZT1cInRyYXNoXCIgY2xhc3M9XCJpY29uQnV0dG9uXCIgKGNsaWNrKT1cInJlbW92ZUxheWVyR3JvdXAoZ3JvdXApXCJcbiAgICAgICAgdGl0bGU9XCJSZW1vdmUgZ3JvdXBcIj48L2Nsci1pY29uPlxuICAgIDwvZGl2PlxuXG4gICAgPGRpdiBjbGFzcz1cImluZm9cIiAqbmdJZj1cInNob3dJbmZvXCI+XG4gICAgICA8c3BhbiBbaW5uZXJIVE1MXT1cImdyb3VwLmRlc2NyaXB0aW9uXCI+PC9zcGFuPlxuICAgIDwvZGl2PlxuICAgIDxkaXYgKm5nSWY9XCJncm91cC5hY3Rpb24gJiYgc2hvd0FjdGlvblwiIGNsYXNzPVwidGFic2JvZHlcIj5cbiAgICAgIDxuZy1jb250YWluZXIgKm5nSWY9XCJjaGVja0lzQ29tcG9uZW50SXRlbShncm91cCwgJ2FjdGlvbicpO1wiPlxuICAgICAgICA8dWtpcy1keW5hbWljLWNvbXBvbmVudCBbKGR5bmFtaWNDb21wb25lbnQpXT1cImdyb3VwLmFjdGlvblwiPlxuICAgICAgICA8L3VraXMtZHluYW1pYy1jb21wb25lbnQ+XG4gICAgICA8L25nLWNvbnRhaW5lcj5cbiAgICA8L2Rpdj5cblxuXG4gICAgPCEtLSAoY2RrRHJvcExpc3RTb3J0ZWQpPVwic29ydCgkZXZlbnQpXCIgIC0tPlxuICAgIDxkaXYgY2RrRHJvcExpc3QgKGNka0Ryb3BMaXN0RHJvcHBlZCk9XCJkcm9wKCRldmVudClcIlxuICAgICAgW2Nka0Ryb3BMaXN0RGF0YV09XCJncm91cC5sYXllcnMgfCBpdGVtc2ZpbHRlcjogY2hlY2tDbGFzc0hpZGUgfCByZXZlcnNlXCI+XG4gICAgICA8bmctY29udGFpbmVyICpuZ0Zvcj1cImxldCBsYXllciBvZiBncm91cC5sYXllcnMgfCBpdGVtc2ZpbHRlcjogY2hlY2tDbGFzc0hpZGUgfCByZXZlcnNlXCI+XG4gICAgICAgIDxkaXYgY2xhc3M9XCJzdWJsYXllcnNcIiBjZGtEcmFnTG9ja0F4aXM9XCJ5XCIgY2RrRHJhZyBbY2RrRHJhZ0RhdGFdPVwie2lkOmxheWVyLmlkfVwiPlxuICAgICAgICAgIDx1a2lzLWxheWVyZW50cnkgW2V4cGFuZGVkXT1cIm9wZW5BbGxMYXllcnNQcm9wZXJ0aWVzXCIgW2xheWVyc1N2Y109XCJsYXllcnNTdmNcIiBbbWFwU3RhdGVdPVwibWFwU3RhdGVcIlxuICAgICAgICAgICAgW2xheWVyXT1cImxheWVyXCIgW2dyb3VwXT1cImdyb3VwXCIgKHVwZGF0ZSk9XCJsYXllclVwZGF0ZSgkZXZlbnQsIGdyb3VwKVwiPlxuICAgICAgICAgICAgPHNwYW4gY2xhc3M9XCJtb3ZlLWl0ZW1cIiBjZGtEcmFnSGFuZGxlPlxuICAgICAgICAgICAgICB7e2xheWVyLmRpc3BsYXlOYW1lIHx8IGxheWVyLm5hbWV9fVxuICAgICAgICAgICAgPC9zcGFuPlxuICAgICAgICAgIDwvdWtpcy1sYXllcmVudHJ5PlxuICAgICAgICA8L2Rpdj5cbiAgICAgIDwvbmctY29udGFpbmVyPlxuICAgIDwvZGl2PlxuICA8L2Rpdj5cbjwvZGl2PlxuIl19